<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Online - Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .sync-icon {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
        }

        .scanner-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        #video {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: #000;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        .status-hadir {
            background: #dcfce7;
            color: #166534;
        }

        .status-sakit {
            background: #fef3c7;
            color: #92400e;
        }

        .status-izin {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-alpha {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Scanner Overlay -->
    <div id="scannerOverlay" class="scanner-overlay">
        <div class="scanner-container">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Scan Kartu Siswa</h3>
                <button onclick="closeScanner()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <video id="video" autoplay></video>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">Arahkan kamera ke QR Code/Barcode kartu siswa</p>
                <button onclick="closeScanner()"
                    class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                    Tutup Scanner
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üë®‚Äçüè´</div>
                <h1 class="text-3xl font-bold text-gray-800">Sistem Absensi Online</h1>
                <h2 class="text-xl font-semibold text-blue-700 mt-2">SDS IT Adzkia 1 Padang</h2>
                <p class="text-gray-600 mt-2">Login Guru/Admin</p>
            </div>

            <form onsubmit="login(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Masukkan username">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Masukkan password">
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                    Login
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-600">
                <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                    <p><strong>üí° Aplikasi ini menggungakan Google Sheets sebagai databasenya.
                        </strong></p>
                    <p class="text-xs text-blue-500 mt-1 italic">Programmer By: Asriadi, S.PdI</p>
                </div>
            </div>


        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="text-2xl mr-3">üë®‚Äçüè´</div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Sistem Absensi Online</h1>
                            <p class="text-sm text-blue-600 font-medium">SDS IT Adzkia 1 Padang</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-gray-600"></span>
                        <button onclick="logout()"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-blue-600 text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('attendance')"
                        class="nav-tab py-4 px-2 border-b-2 border-white transition duration-200">
                        Input Absensi
                    </button>
                    <button onclick="showTab('reports')"
                        class="nav-tab py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200">
                        Laporan & Rekap
                    </button>
                    <button id="studentsNavTab" onclick="showTab('students')"
                        class="nav-tab py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200 hidden">
                        Data Siswa
                    </button>
                    <button id="settingsNavTab" onclick="showTab('settings')"
                        class="nav-tab py-4 px-2 border-b-2 border-transparent hover:border-white transition duration-200 hidden">
                        Pengaturan
                    </button>
                </div>
            </div>
        </nav>

        <!-- Attendance Tab -->
        <div id="attendanceTab" class="tab-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Class Selection -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Pilih Kelas & Mata Pelajaran</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="classSelect" onchange="loadStudents()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="X-IPA-1">X IPA 1</option>
                            <option value="X-IPA-2">X IPA 2</option>
                            <option value="XI-IPA-1">XI IPA 1</option>
                            <option value="XI-IPA-2">XI IPA 2</option>
                            <option value="XII-IPA-1">XII IPA 1</option>
                            <option value="XII-IPA-2">XII IPA 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran / Kegiatan</label>
                        <select id="subjectSelect" onchange="loadStudents()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Mata Pelajaran / Kegiatan</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Fisika">Fisika</option>
                            <option value="Kimia">Kimia</option>
                            <option value="Biologi">Biologi</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                        <input type="date" id="attendanceDate" onchange="loadStudents()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Pelajaran</label>
                        <select id="timeSlot" onchange="loadStudents()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="07:50-09:00">07:50 - 09:00</option>
                            <option value="10:40-11:50">10:40 - 11:50</option>
                            <option value="13:10-14:20">13:10 - 14:20</option>
                            <option value="14:20-15:30">14:20 - 15:30</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Scanner Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Scan Kartu Siswa</h3>
                    <button onclick="openScanner()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h2M4 4h4m12 0h2M4 20h4m12 0h2">
                            </path>
                        </svg>
                        Buka Scanner
                    </button>
                </div>
                <div id="scanResult" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-green-800">Siswa berhasil dipindai: <span id="scannedStudent"
                            class="font-semibold"></span></p>
                </div>
            </div>

            <!-- Students List -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Daftar Siswa</h3>
                    <div class="flex space-x-2">
                        <button onclick="markAllPresent()"
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                            Semua Hadir
                        </button>
                        <button onclick="saveAttendance()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Simpan Absensi
                        </button>
                    </div>
                </div>

                <div id="studentsContainer" class="space-y-2">
                    <p class="text-gray-500 text-center py-8">Pilih kelas untuk menampilkan daftar siswa</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Filter Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Filter Laporan</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="reportClass"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelas</option>
                            <option value="X-IPA-1">X IPA 1</option>
                            <option value="X-IPA-2">X IPA 2</option>
                            <option value="XI-IPA-1">XI IPA 1</option>
                            <option value="XI-IPA-2">XI IPA 2</option>
                            <option value="XII-IPA-1">XII IPA 1</option>
                            <option value="XII-IPA-2">XII IPA 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran / Kegiatan</label>
                        <select id="reportSubject"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Mata Pelajaran / Kegiatan</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Fisika">Fisika</option>
                            <option value="Kimia">Kimia</option>
                            <option value="Biologi">Biologi</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                        <input type="date" id="reportStartDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                        <input type="date" id="reportEndDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="reportStatus"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Status</option>
                            <option value="Hadir">Hadir</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Alpha">Alpha</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="generateReport()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Generate Laporan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="text-3xl text-green-500 mr-4">‚úÖ</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Hadir</p>
                            <p id="totalPresent" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="text-3xl text-yellow-500 mr-4">ü§í</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Sakit</p>
                            <p id="totalSick" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="text-3xl text-blue-500 mr-4">üìù</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Izin</p>
                            <p id="totalPermission" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="text-3xl text-red-500 mr-4">‚ùå</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Alpha</p>
                            <p id="totalAbsent" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Table -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Data Absensi</h3>
                    <div class="flex space-x-2">
                        <button onclick="exportToPDF()"
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            üìÑ Export PDF
                        </button>
                        <button onclick="exportToExcel()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            üìä Export Excel
                        </button>
                        <button onclick="syncAttendanceToSheets()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            üîÑ Sync Absensi
                        </button>

                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Kelas</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nama Siswa</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    NIS</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Mata Pelajaran / Kegiatan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Jam</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Guru</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="text-center py-8 text-gray-500">Klik "Generate Laporan" untuk
                                    menampilkan data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="studentsTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Student Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Manajemen Data Siswa</h2>
                    <div class="flex space-x-2">
                        <button onclick="showAddStudentModal()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            + Tambah Siswa
                        </button>
                        <button onclick="syncStudentsToSheets()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Sync ke Google Sheets
                        </button>
                        <button onclick="generateAllQRCodes()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                            Generate Semua QR Code
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label>
                            <select id="studentFilterClass" onchange="filterStudents()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Kelas</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Siswa</label>
                            <input type="text" id="studentSearch" onkeyup="filterStudents()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Cari berdasarkan nama atau NIS...">
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    NIS</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nama Lengkap</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Kelas</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    QR Code</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Students data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- QR Code Display Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">QR Code Siswa</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 justify-center"
                    id="studentsQRContainer">
                    <!-- Student QR codes will be generated here -->
                </div>
            </div>
        </div>

        <!-- Add/Edit Student Modal -->
        <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="studentModalTitle" class="text-xl font-bold text-gray-800">Tambah Siswa Baru</h3>
                        <button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="studentForm" onsubmit="saveStudent(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIS *</label>
                                <input type="text" id="studentId" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Contoh: 2024001">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                                <input type="text" id="studentName" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Nama lengkap siswa">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                                <select id="studentClass" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">QR Code</label>
                                <input type="text" id="studentQR"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Otomatis di-generate jika kosong">
                                <p class="text-xs text-gray-500 mt-1">Biarkan kosong untuk generate otomatis</p>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closeStudentModal()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
                <div class="p-6">
                    <div class="text-center">
                        <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Konfirmasi Hapus</h3>
                        <p id="deleteModalMessage" class="text-gray-600 mb-6">Yakin ingin menghapus data ini? Tindakan
                            ini tidak dapat dibatalkan.</p>

                        <div class="flex justify-center space-x-3">
                            <button onclick="closeDeleteModal()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button id="confirmDeleteBtn" onclick="confirmDeleteStudent()"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                                Hapus
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Teacher Modal -->
        <div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="teacherModalTitle" class="text-xl font-bold text-gray-800">Tambah Guru Baru</h3>
                        <button onclick="closeTeacherModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="teacherForm" onsubmit="saveTeacher(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                                <input type="text" id="teacherUsername" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Username untuk login">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                <input type="password" id="teacherPassword" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Password untuk login">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                                <input type="text" id="teacherName" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Nama lengkap guru">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                                <select id="teacherRole" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Role</option>
                                    <option value="teacher">Guru</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closeTeacherModal()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Google Apps Script Settings -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Pengaturan Google Apps Script</h2>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Apps Script Deployment ID
                                *</label>
                            <input type="text" id="deploymentId" readonly
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                placeholder="AKfycbx...">
                            <p class="text-xs text-gray-500 mt-1">ID deployment dari Google Apps Script web app (Sudah
                                dikonfigurasi)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Apps Script Web App URL
                                *</label>
                            <input type="url" id="webAppUrl" readonly
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                placeholder="https://script.google.com/macros/s/AKfycbx.../exec">
                            <p class="text-xs text-gray-500 mt-1">URL lengkap web app dari Google Apps Script (Sudah
                                dikonfigurasi)</p>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">URL Google Sheets untuk Setiap Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sheet Absensi URL</label>
                                <input type="url" id="attendanceSheetUrl" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                    placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit#gid=0">
                                <p class="text-xs text-gray-500 mt-1">URL sheet untuk data absensi siswa (Sudah
                                    dikonfigurasi)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Siswa URL</label>
                                <input type="url" id="studentsSheetUrl" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                    placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit#gid=1">
                                <p class="text-xs text-gray-500 mt-1">URL sheet untuk data siswa (Sudah dikonfigurasi)
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Guru URL</label>
                                <input type="url" id="teachersSheetUrl" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                    placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit#gid=2">
                                <p class="text-xs text-gray-500 mt-1">URL sheet untuk data guru (Sudah dikonfigurasi)
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran URL</label>
                                <input type="url" id="subjectsSheetUrl" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                    placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit#gid=3">
                                <p class="text-xs text-gray-500 mt-1">URL sheet untuk mata pelajaran (Sudah
                                    dikonfigurasi)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Kelas URL</label>
                                <input type="url" id="classesSheetUrl" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                                    placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit#gid=4">
                                <p class="text-xs text-gray-500 mt-1">URL sheet untuk data kelas (Sudah dikonfigurasi)
                                </p>
                            </div>


                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-4 border-t">
                        <button onclick="testAppsScriptConnection()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            üîç Test Koneksi
                        </button>
                        <button onclick="saveSettings()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            üíæ Simpan Pengaturan
                        </button>
                    </div>

                    <div id="connectionStatus" class="hidden p-4 rounded-lg">
                        <p id="connectionMessage" class="text-sm font-medium"></p>
                    </div>
                </div>

                <div class="mt-8 p-4 bg-blue-50 rounded-lg hidden">
                    <h3 class="font-semibold text-blue-800 mb-2">üìã Panduan Setup Google Apps Script</h3>
                    <ol class="text-sm text-blue-700 space-y-2">
                        <li><strong>1. Buat Google Sheets baru:</strong>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>‚Ä¢ Buka Google Sheets dan buat spreadsheet baru</li>
                                <li>‚Ä¢ Buat header di baris pertama: Tanggal | Kelas | Nama Siswa | ID Siswa | Mata
                                    Pelajaran | Status | Jam | Guru</li>
                            </ul>
                        </li>
                        <li><strong>2. Buat Google Apps Script:</strong>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>‚Ä¢ Buka script.google.com</li>
                                <li>‚Ä¢ Buat project baru</li>
                                <li>‚Ä¢ Copy kode Apps Script dari panduan di bawah</li>
                                <li>‚Ä¢ Buat sheet tambahan: "Jam Pelajaran" dengan header "Jam Pelajaran"</li>
                            </ul>
                        </li>
                        <li><strong>3. Deploy sebagai Web App:</strong>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>‚Ä¢ Klik Deploy > New deployment</li>
                                <li>‚Ä¢ Pilih type: Web app</li>
                                <li>‚Ä¢ Execute as: Me</li>
                                <li>‚Ä¢ Who has access: Anyone</li>
                                <li>‚Ä¢ Copy deployment ID</li>
                            </ul>
                        </li>
                        <li><strong>4. Masukkan konfigurasi:</strong>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>‚Ä¢ Paste URL Google Sheets</li>
                                <li>‚Ä¢ Paste deployment ID</li>
                                <li>‚Ä¢ Test koneksi</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <!-- Troubleshooting Guide -->
                <div class="mt-6 p-4 bg-red-50 rounded-lg hidden">
                    <h3 class="font-semibold text-red-800 mb-2">üîß Troubleshooting "Failed to fetch"</h3>
                    <div class="text-sm text-red-700 space-y-2">
                        <p><strong>Jika masih gagal koneksi, periksa hal berikut:</strong></p>
                        <ol class="ml-4 space-y-1">
                            <li><strong>1. Pastikan Apps Script sudah di-deploy:</strong>
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>‚Ä¢ Buka script.google.com</li>
                                    <li>‚Ä¢ Pilih project Anda</li>
                                    <li>‚Ä¢ Klik "Deploy" > "Manage deployments"</li>
                                    <li>‚Ä¢ Pastikan ada deployment aktif dengan type "Web app"</li>
                                </ul>
                            </li>
                            <li><strong>2. Periksa permission Apps Script:</strong>
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>‚Ä¢ Execute as: <strong>Me</strong> (bukan User accessing the web app)</li>
                                    <li>‚Ä¢ Who has access: <strong>Anyone</strong></li>
                                    <li>‚Ä¢ Jika sudah benar, coba buat deployment baru</li>
                                </ul>
                            </li>
                            <li><strong>3. Test manual Apps Script:</strong>
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>‚Ä¢ Buka URL web app di browser baru</li>
                                    <li>‚Ä¢ Jika muncul "Authorization required", klik "Review permissions"</li>
                                    <li>‚Ä¢ Login dengan akun Google yang sama</li>
                                    <li>‚Ä¢ Klik "Allow" untuk memberikan permission</li>
                                </ul>
                            </li>
                            <li><strong>4. Periksa format URL:</strong>
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>‚Ä¢ URL harus: https://script.google.com/macros/s/[DEPLOYMENT_ID]/exec</li>
                                    <li>‚Ä¢ Pastikan tidak ada spasi atau karakter tambahan</li>
                                    <li>‚Ä¢ Deployment ID biasanya panjang ~100 karakter</li>
                                </ul>
                            </li>
                            <li><strong>5. Coba langkah alternatif:</strong>
                                <ul class="ml-4 mt-1 space-y-1">
                                    <li>‚Ä¢ Hapus deployment lama, buat deployment baru</li>
                                    <li>‚Ä¢ Gunakan akun Google yang berbeda</li>
                                    <li>‚Ä¢ Coba dari browser incognito/private</li>
                                    <li>‚Ä¢ Pastikan tidak ada ad blocker yang memblokir</li>
                                </ul>
                            </li>
                        </ol>
                        <div class="mt-3 p-3 bg-yellow-100 rounded border-l-4 border-yellow-500">
                            <p class="font-medium text-yellow-800">üí° Tips:</p>
                            <p class="text-yellow-700">Sistem akan mencoba 3 metode koneksi berbeda secara otomatis.
                                Jika semua gagal, kemungkinan besar masalah ada di konfigurasi Apps Script.</p>
                        </div>
                    </div>
                </div>

                <!-- Apps Script Code Template -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="font-semibold text-gray-800 mb-2">üìÑ Kode Google Apps Script (Versi Terbaru - Fixed)</h4>
                    <div class="bg-gray-800 text-green-400 p-4 rounded text-xs font-mono overflow-x-auto">
                        <pre>// Handle both GET and POST requests
function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    let data;
    let action;
    
    // Handle different request types
    if (e.postData && e.postData.contents) {
      // POST request with JSON
      data = JSON.parse(e.postData.contents);
      action = data.action;
    } else if (e.postData && e.postData.type === 'multipart/form-data') {
      // POST request with form data
      const payload = e.parameter.payload;
      if (payload) {
        data = JSON.parse(payload);
        action = data.action;
      }
    } else if (e.parameter) {
      // GET request with parameters
      action = e.parameter.action;
      if (e.parameter.data) {
        data = JSON.parse(e.parameter.data);
      } else {
        data = e.parameter;
      }
    }
    
    if (!action) {
      action = 'test'; // Default action for testing
    }
    
    // Test connection
    if (action === 'test') {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true, 
          message: 'Koneksi berhasil! Apps Script berfungsi dengan baik.',
          timestamp: new Date().toISOString()
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Extract sheet ID from URL
    const extractSheetId = (url) => {
      if (!url) return null;
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    };
    
    // Get sheet by URL and name with better error handling
    const getSheetByUrl = (url, sheetName) => {
      const sheetId = extractSheetId(url);
      if (!sheetId) {
        console.error('Invalid sheet URL:', url);
        return null;
      }
      
      try {
        const spreadsheet = SpreadsheetApp.openById(sheetId);
        let sheet = spreadsheet.getSheetByName(sheetName);
        
        if (!sheet) {
          console.log('Creating new sheet:', sheetName);
          sheet = spreadsheet.insertSheet(sheetName);
        }
        
        return sheet;
      } catch (error) {
        console.error('Error accessing sheet:', error);
        console.error('Sheet ID:', sheetId);
        console.error('Sheet Name:', sheetName);
        return null;
      }
    };
    
    // Helper function to ensure sheet has proper headers
    const ensureSheetHeaders = (sheet, headers) => {
      if (!sheet) return false;
      
      try {
        if (sheet.getLastRow() === 0) {
          sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
          console.log('Headers added to sheet:', headers);
        }
        return true;
      } catch (error) {
        console.error('Error setting headers:', error);
        return false;
      }
    };
    
    // Append new attendance data (for real-time saving)
    if (action === 'appendAttendance') {
      const attendanceData = data.attendanceData;
      const sheetUrl = data.attendanceSheetUrl;
      
      console.log('Append attendance - URL:', sheetUrl);
      console.log('Append attendance - Data count:', attendanceData ? attendanceData.length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Sheet Absensi');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Absensi. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      // Ensure headers exist
      const headers = ['Tanggal', 'Kelas', 'Nama Siswa', 'ID Siswa', 'Mata Pelajaran', 'Status', 'Jam', 'Guru'];
      if (!ensureSheetHeaders(sheet, headers)) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      // Append new data
      let addedCount = 0;
      if (attendanceData && attendanceData.length > 0) {
        try {
          attendanceData.forEach(record => {
            sheet.appendRow([
              record.date || '', 
              record.class || '', 
              record.studentName || '', 
              record.studentId || '',
              record.subject || '', 
              record.status || '', 
              record.time || '', 
              record.teacher || ''
            ]);
            addedCount++;
          });
          console.log('Successfully added', addedCount, 'records');
        } catch (error) {
          console.error('Error appending data:', error);
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: `Error menambah data: ${error.toString()}`}))
            .setMimeType(ContentService.MimeType.JSON);
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: `${addedCount} data absensi berhasil disimpan ke Sheet Absensi!`}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Sync Attendance Data (replace all data)
    if (action === 'syncAttendance') {
      const attendanceData = data.attendanceData;
      const sheetUrl = data.attendanceSheetUrl;
      
      console.log('Sync attendance - URL:', sheetUrl);
      console.log('Sync attendance - Data count:', attendanceData ? attendanceData.length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Sheet Absensi');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Absensi. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        // Ensure headers exist
        const headers = ['Tanggal', 'Kelas', 'Nama Siswa', 'ID Siswa', 'Mata Pelajaran', 'Status', 'Jam', 'Guru'];
        if (!ensureSheetHeaders(sheet, headers)) {
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Clear existing data (keep header)
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          sheet.deleteRows(2, lastRow - 1);
          console.log('Cleared', lastRow - 1, 'existing rows');
        }
        
        // Add new data
        let addedCount = 0;
        if (attendanceData && attendanceData.length > 0) {
          attendanceData.forEach(record => {
            sheet.appendRow([
              record.date || '', 
              record.class || '', 
              record.studentName || '', 
              record.studentId || '',
              record.subject || '', 
              record.status || '', 
              record.time || '', 
              record.teacher || ''
            ]);
            addedCount++;
          });
          console.log('Successfully synced', addedCount, 'records');
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Data absensi berhasil disinkronkan ke Sheet Absensi! (${addedCount} record)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error syncing attendance:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error sync absensi: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Sync Students Data
    if (action === 'syncStudents') {
      const studentsData = data.studentsData;
      const sheetUrl = data.studentsSheetUrl;
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Siswa');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Data Siswa'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      // Set header if empty
      if (sheet.getLastRow() === 0) {
        sheet.getRange(1, 1, 1, 4).setValues([['ID Siswa', 'Nama Lengkap', 'Kelas', 'QR Code']]);
      }
      
      // Clear existing data (keep header)
      if (sheet.getLastRow() > 1) {
        sheet.deleteRows(2, sheet.getLastRow() - 1);
      }
      
      // Add students data
      let totalStudents = 0;
      if (studentsData) {
        Object.entries(studentsData).forEach(([className, students]) => {
          if (students && Array.isArray(students)) {
            students.forEach(student => {
              sheet.appendRow([student.id, student.name, className, student.qr]);
              totalStudents++;
            });
          }
        });
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: `Data siswa berhasil disinkronkan! (${totalStudents} siswa)`}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Load Students Data
    if (action === 'loadStudents') {
      const sheetUrl = data.studentsSheetUrl;
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Siswa');
      if (!sheet || sheet.getLastRow() <= 1) {
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: {}}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const data = sheet.getDataRange().getValues();
      const studentsData = {};
      
      for (let i = 1; i < data.length; i++) {
        const [id, name, className, qr] = data[i];
        if (id && name && className) {
          if (!studentsData[className]) {
            studentsData[className] = [];
          }
          studentsData[className].push({id: id.toString(), name, qr: qr || `STD${id}`});
        }
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, data: studentsData}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Sync Teachers Data
    if (action === 'syncTeachers') {
      const teachersData = data.teachersData;
      const sheetUrl = data.teachersSheetUrl;
      
      console.log('Sync teachers - URL:', sheetUrl);
      console.log('Sync teachers - Data count:', teachersData ? Object.keys(teachersData).length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Guru');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Data Guru. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        // Ensure headers exist
        const headers = ['Username', 'Password', 'Nama Lengkap', 'Role'];
        if (!ensureSheetHeaders(sheet, headers)) {
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Clear existing data (keep header)
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          sheet.deleteRows(2, lastRow - 1);
          console.log('Cleared', lastRow - 1, 'existing teacher rows');
        }
        
        // Add teachers data
        let totalTeachers = 0;
        if (teachersData) {
          Object.entries(teachersData).forEach(([username, teacher]) => {
            sheet.appendRow([
              username || '', 
              teacher.password || '', 
              teacher.name || username, 
              teacher.role || 'teacher'
            ]);
            totalTeachers++;
          });
          console.log('Successfully synced', totalTeachers, 'teachers');
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Data guru berhasil disinkronkan ke Sheet Data Guru! (${totalTeachers} guru)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error syncing teachers:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error sync guru: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Load Teachers Data
    if (action === 'loadTeachers') {
      const sheetUrl = data.teachersSheetUrl;
      
      console.log('Load teachers - URL:', sheetUrl);
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Guru');
      if (!sheet || sheet.getLastRow() <= 1) {
        console.log('No teacher data found or sheet empty');
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: {}}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const sheetData = sheet.getDataRange().getValues();
        const teachersData = {};
        
        for (let i = 1; i < sheetData.length; i++) {
          const [username, password, name, role] = sheetData[i];
          if (username && password) {
            teachersData[username] = {
              password: password, 
              name: name || username, 
              role: role || 'teacher'
            };
          }
        }
        
        console.log('Loaded', Object.keys(teachersData).length, 'teachers');
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: teachersData}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error loading teachers:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error load guru: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Sync Subjects Data
    if (action === 'syncSubjects') {
      const subjectsData = data.subjectsData;
      const sheetUrl = data.subjectsSheetUrl;
      
      console.log('Sync subjects - URL:', sheetUrl);
      console.log('Sync subjects - Data count:', subjectsData ? subjectsData.length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Mata Pelajaran');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Mata Pelajaran. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        // Ensure headers exist
        const headers = ['Nama Mata Pelajaran'];
        if (!ensureSheetHeaders(sheet, headers)) {
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Clear existing data (keep header)
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          sheet.deleteRows(2, lastRow - 1);
          console.log('Cleared', lastRow - 1, 'existing subject rows');
        }
        
        // Add subjects data
        let totalSubjects = 0;
        if (subjectsData && Array.isArray(subjectsData)) {
          subjectsData.forEach(subject => {
            if (subject) {
              sheet.appendRow([subject]);
              totalSubjects++;
            }
          });
          console.log('Successfully synced', totalSubjects, 'subjects');
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Data mata pelajaran berhasil disinkronkan ke Sheet Mata Pelajaran! (${totalSubjects} mata pelajaran)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error syncing subjects:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error sync mata pelajaran: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Load Subjects Data
    if (action === 'loadSubjects') {
      const sheetUrl = data.subjectsSheetUrl;
      
      console.log('Load subjects - URL:', sheetUrl);
      
      const sheet = getSheetByUrl(sheetUrl, 'Mata Pelajaran');
      if (!sheet || sheet.getLastRow() <= 1) {
        console.log('No subject data found or sheet empty');
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: []}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const sheetData = sheet.getDataRange().getValues();
        const subjectsData = [];
        
        for (let i = 1; i < sheetData.length; i++) {
          if (sheetData[i][0]) {
            subjectsData.push(sheetData[i][0]);
          }
        }
        
        console.log('Loaded', subjectsData.length, 'subjects');
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: subjectsData}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error loading subjects:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error load mata pelajaran: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Sync Classes Data
    if (action === 'syncClasses') {
      const classesData = data.classesData;
      const sheetUrl = data.classesSheetUrl;
      
      console.log('Sync classes - URL:', sheetUrl);
      console.log('Sync classes - Data count:', classesData ? classesData.length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Kelas');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Data Kelas. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        // Ensure headers exist
        const headers = ['Nama Kelas'];
        if (!ensureSheetHeaders(sheet, headers)) {
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Clear existing data (keep header)
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          sheet.deleteRows(2, lastRow - 1);
          console.log('Cleared', lastRow - 1, 'existing class rows');
        }
        
        // Add classes data
        let totalClasses = 0;
        if (classesData && Array.isArray(classesData)) {
          classesData.forEach(className => {
            if (className) {
              sheet.appendRow([className]);
              totalClasses++;
            }
          });
          console.log('Successfully synced', totalClasses, 'classes');
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Data kelas berhasil disinkronkan ke Sheet Data Kelas! (${totalClasses} kelas)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error syncing classes:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error sync kelas: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Load Classes Data
    if (action === 'loadClasses') {
      const sheetUrl = data.classesSheetUrl;
      
      console.log('Load classes - URL:', sheetUrl);
      
      const sheet = getSheetByUrl(sheetUrl, 'Data Kelas');
      if (!sheet || sheet.getLastRow() <= 1) {
        console.log('No class data found or sheet empty');
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: []}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const sheetData = sheet.getDataRange().getValues();
        const classesData = [];
        
        for (let i = 1; i < sheetData.length; i++) {
          if (sheetData[i][0]) {
            classesData.push(sheetData[i][0]);
          }
        }
        
        console.log('Loaded', classesData.length, 'classes');
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: classesData}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error loading classes:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error load kelas: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Sync Time Slots Data
    if (action === 'syncTimeSlots') {
      const timeSlotsData = data.timeSlotsData;
      const sheetUrl = data.timeSlotsSheetUrl;
      
      console.log('Sync time slots - URL:', sheetUrl);
      console.log('Sync time slots - Data count:', timeSlotsData ? timeSlotsData.length : 0);
      
      const sheet = getSheetByUrl(sheetUrl, 'Jam Pelajaran');
      if (!sheet) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'Tidak dapat mengakses Sheet Jam Pelajaran. Periksa URL dan permission.'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        // Ensure headers exist
        const headers = ['Jam Pelajaran'];
        if (!ensureSheetHeaders(sheet, headers)) {
          return ContentService
            .createTextOutput(JSON.stringify({success: false, message: 'Gagal mengatur header sheet'}))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Clear existing data (keep header)
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          sheet.deleteRows(2, lastRow - 1);
          console.log('Cleared', lastRow - 1, 'existing time slot rows');
        }
        
        // Add time slots data
        let totalTimeSlots = 0;
        if (timeSlotsData && Array.isArray(timeSlotsData)) {
          timeSlotsData.forEach(timeSlot => {
            if (timeSlot) {
              sheet.appendRow([timeSlot]);
              totalTimeSlots++;
            }
          });
          console.log('Successfully synced', totalTimeSlots, 'time slots');
        }
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Data jam pelajaran berhasil disinkronkan ke Sheet Jam Pelajaran! (${totalTimeSlots} jam pelajaran)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error syncing time slots:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error sync jam pelajaran: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Load Time Slots Data
    if (action === 'loadTimeSlots') {
      const sheetUrl = data.timeSlotsSheetUrl;
      
      console.log('Load time slots - URL:', sheetUrl);
      
      const sheet = getSheetByUrl(sheetUrl, 'Jam Pelajaran');
      if (!sheet || sheet.getLastRow() <= 1) {
        console.log('No time slot data found or sheet empty');
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: []}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const sheetData = sheet.getDataRange().getValues();
        const timeSlotsData = [];
        
        for (let i = 1; i < sheetData.length; i++) {
          if (sheetData[i][0]) {
            timeSlotsData.push(sheetData[i][0]);
          }
        }
        
        console.log('Loaded', timeSlotsData.length, 'time slots');
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, data: timeSlotsData}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error loading time slots:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error load jam pelajaran: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Validate Attendance Data
    if (action === 'validateAttendance') {
      const validationData = data.validationData;
      const sheetUrl = data.attendanceSheetUrl;
      
      const sheet = getSheetByUrl(sheetUrl, 'Sheet Absensi');
      if (!sheet || sheet.getLastRow() <= 1) {
        return ContentService
          .createTextOutput(JSON.stringify({success: true, conflicts: []}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const sheetData = sheet.getDataRange().getValues();
      const conflicts = [];
      
      // Check each student ID for conflicts
      validationData.studentIds.forEach(studentId => {
        for (let i = 1; i < sheetData.length; i++) {
          const [date, className, studentName, sheetStudentId, subject, status, time, teacher] = sheetData[i];
          
          if (sheetStudentId == studentId && 
              subject === validationData.subject && 
              date === validationData.date && 
              time === validationData.timeSlot) {
            
            conflicts.push({
              studentId: studentId.toString(),
              studentName: studentName,
              status: status,
              teacher: teacher || 'Unknown'
            });
            break; // Found conflict for this student, no need to check further
          }
        }
      });
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, conflicts: conflicts}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Create sample sheets
    if (action === 'createSampleSheets') {
      const sheetUrl = data.mainSheetUrl;
      const sheetId = extractSheetId(sheetUrl);
      
      console.log('Create sample sheets - URL:', sheetUrl);
      console.log('Create sample sheets - Sheet ID:', sheetId);
      
      if (!sheetId) {
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: 'URL Google Sheets tidak valid'}))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const spreadsheet = SpreadsheetApp.openById(sheetId);
        
        // Create sample sheets with headers
        const sheetsConfig = [
          {name: 'Sheet Absensi', headers: ['Tanggal', 'Kelas', 'Nama Siswa', 'ID Siswa', 'Mata Pelajaran', 'Status', 'Jam', 'Guru']},
          {name: 'Data Siswa', headers: ['ID Siswa', 'Nama Lengkap', 'Kelas', 'QR Code']},
          {name: 'Data Guru', headers: ['Username', 'Password', 'Nama Lengkap', 'Role']},
          {name: 'Mata Pelajaran', headers: ['Nama Mata Pelajaran']},
          {name: 'Data Kelas', headers: ['Nama Kelas']},
          {name: 'Jam Pelajaran', headers: ['Jam Pelajaran']}
        ];
        
        let createdCount = 0;
        
        sheetsConfig.forEach(config => {
          try {
            let sheet = spreadsheet.getSheetByName(config.name);
            if (!sheet) {
              sheet = spreadsheet.insertSheet(config.name);
              console.log('Created new sheet:', config.name);
            } else {
              console.log('Sheet already exists:', config.name);
            }
            
            // Set headers if sheet is empty
            if (sheet.getLastRow() === 0) {
              sheet.getRange(1, 1, 1, config.headers.length).setValues([config.headers]);
              console.log('Added headers to sheet:', config.name);
              
              // Add sample data for some sheets
              if (config.name === 'Data Guru') {
                sheet.appendRow(['guru', 'guru123', 'Budi Santoso, S.Pd', 'teacher']);
                sheet.appendRow(['admin', 'admin123', 'Admin Sekolah', 'admin']);
                console.log('Added sample teacher data');
              } else if (config.name === 'Mata Pelajaran') {
                ['Matematika', 'Fisika', 'Kimia', 'Biologi', 'Bahasa Indonesia', 'Bahasa Inggris'].forEach(subject => {
                  sheet.appendRow([subject]);
                });
                console.log('Added sample subject data');
              } else if (config.name === 'Data Kelas') {
                ['X-IPA-1', 'X-IPA-2', 'XI-IPA-1', 'XI-IPA-2', 'XII-IPA-1', 'XII-IPA-2'].forEach(className => {
                  sheet.appendRow([className]);
                });
                console.log('Added sample class data');
              } else if (config.name === 'Jam Pelajaran') {
                ['07:20-07:50', '07:50-09:00', '09:00-10:10', '10:10-10:40', '10:40-11:50', '11:50-13:10', '13:10-14:20', '14:20-15:30', '15:30-16:30'].forEach(timeSlot => {
                  sheet.appendRow([timeSlot]);
                });
                console.log('Added sample time slot data');
              }
            }
            
            createdCount++;
            
          } catch (sheetError) {
            console.error('Error creating sheet:', config.name, sheetError);
          }
        });
        
        console.log('Successfully processed', createdCount, 'sheets');
        
        return ContentService
          .createTextOutput(JSON.stringify({success: true, message: `Sample sheets berhasil dibuat! (${createdCount} sheets diproses)`}))
          .setMimeType(ContentService.MimeType.JSON);
          
      } catch (error) {
        console.error('Error creating sample sheets:', error);
        return ContentService
          .createTextOutput(JSON.stringify({success: false, message: `Error membuat sample sheets: ${error.toString()}`}))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: 'Action tidak dikenali: ' + action}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('Apps Script Error:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        message: `Error: ${error.toString()}`,
        stack: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">Copy kode di atas ke Google Apps Script editor Anda</p>
                </div>
            </div>

            <!-- Class Configuration -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Pengaturan Kelas</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Kelas</label>
                        <div id="classListContainer" class="space-y-2 mb-4">
                            <!-- Class list will be populated here -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="newClassName"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Nama kelas baru (contoh: X-IPA-3)">
                            <button onclick="addClass()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                Tambah Kelas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subject Configuration -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Pengaturan Mata Pelajaran / Kegiatan</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Mata Pelajaran /
                            Kegiatan</label>
                        <div id="subjectListContainer" class="space-y-2 mb-4">
                            <!-- Subject list will be populated here -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="newSubjectName"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Nama mata pelajaran baru">
                            <button onclick="addSubject()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                Tambah Mata Pelajaran / Kegiatan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Manajemen Data Guru</h2>
                    <div class="flex space-x-2">
                        <button onclick="showAddTeacherModal()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            + Tambah Guru
                        </button>
                        <button onclick="syncTeachersToSheets()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Sync ke Google Sheets
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Role</label>
                            <select id="teacherFilterRole" onchange="filterTeachers()"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Role</option>
                                <option value="teacher">Guru</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari Guru</label>
                            <input type="text" id="teacherSearch" onkeyup="filterTeachers()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Cari berdasarkan nama atau username...">
                        </div>
                    </div>
                </div>

                <!-- Teachers Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Username</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nama Lengkap</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Role</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Password</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Teachers data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Time Slot Configuration -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Pengaturan Jam Pelajaran</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Jam Pelajaran</label>
                        <div id="timeSlotListContainer" class="space-y-2 mb-4">
                            <!-- Time slot list will be populated here -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="time" id="newTimeStart"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <span class="flex items-center text-gray-500">-</span>
                            <input type="time" id="newTimeEnd"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button onclick="addTimeSlot()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                Tambah Jam
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let studentsData = JSON.parse(localStorage.getItem('studentsData')) || {};
        let codeReader = null;

        // Configuration data
        let classConfig = JSON.parse(localStorage.getItem('classConfig')) || [
            'X-IPA-1', 'X-IPA-2', 'XI-IPA-1', 'XI-IPA-2', 'XII-IPA-1', 'XII-IPA-2'
        ];
        let subjectConfig = JSON.parse(localStorage.getItem('subjectConfig')) || [
            'Matematika', 'Fisika', 'Kimia', 'Biologi', 'Bahasa Indonesia', 'Bahasa Inggris'
        ];
        let timeSlotConfig = JSON.parse(localStorage.getItem('timeSlotConfig')) || [
            '07:20-07:50', '07:50-09:00', '09:00-10:10', '10:10-10:40', '10:40-11:50', '11:50-13:10', '13:10-14:20', '14:20-15:30', '15:30-16:30'
        ];

        // Demo users
        const users = {
            guru: { password: 'guru123', role: 'teacher', name: 'Budi Santoso, S.Pd' },
            admin: { password: 'admin123', role: 'admin', name: 'Admin Sekolah' }
        };

        // Sample students data
        const sampleStudents = {
            'X-IPA-1': [
                { id: '2024001', name: 'Ahmad Rizki Pratama', qr: 'STD2024001' },
                { id: '2024002', name: 'Sari Dewi Lestari', qr: 'STD2024002' },
                { id: '2024003', name: 'Budi Setiawan', qr: 'STD2024003' },
                { id: '2024004', name: 'Rina Maharani', qr: 'STD2024004' },
                { id: '2024005', name: 'Doni Prasetyo', qr: 'STD2024005' }
            ],
            'X-IPA-2': [
                { id: '2024006', name: 'Maya Sari', qr: 'STD2024006' },
                { id: '2024007', name: 'Andi Wijaya', qr: 'STD2024007' },
                { id: '2024008', name: 'Lina Permata', qr: 'STD2024008' },
                { id: '2024009', name: 'Rudi Hartono', qr: 'STD2024009' },
                { id: '2024010', name: 'Sinta Dewi', qr: 'STD2024010' }
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // Set today's date
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = new Date().toISOString().split('T')[0];

            // Initialize default configuration if not exists
            initializeDefaultConfiguration();

            // Initialize students data if empty and no Google Sheets config
            if (Object.keys(studentsData).length === 0 && !localStorage.getItem('deploymentId')) {
                studentsData = sampleStudents;
                localStorage.setItem('studentsData', JSON.stringify(studentsData));
            }

            // Populate dropdowns
            populateDropdowns();

            // Always try to load data from Google Sheets using default or stored configuration
            const webAppUrl = localStorage.getItem('webAppUrl') || defaultConfig.webAppUrl;

            if (webAppUrl) {
                console.log('üîÑ Memulai sinkronisasi otomatis dengan Google Sheets...');
                console.log('üåê Web App URL:', webAppUrl);

                // Tampilkan indikator loading dengan animasi berputar
                showLoginLoadingStatus(
                    'üîÑ Menyinkronkan dengan Google Sheets...',
                    'info'
                );

                // Load data with enhanced error handling and user feedback
                loadDataFromSheetsOnStartup().then((result) => {
                    if (result.loadedCount > 0) {
                        console.log(`‚úÖ Sinkronisasi berhasil: ${result.loadedCount} sheets dimuat`);
                        populateDropdowns(); // Refresh dropdowns with new data
                        showLoginLoadingStatus(`‚úÖ Sinkronisasi berhasil! ${result.loadedCount} data dimuat dari Google Sheets.`, 'success');

                        // Hide status after 3 seconds
                        setTimeout(() => {
                            hideLoginLoadingStatus();
                        }, 3000);
                    } else {
                        console.log('‚ÑπÔ∏è Tidak ada data baru dimuat dari Google Sheets');
                        showLoginLoadingStatus('‚ÑπÔ∏è Menggunakan data lokal (tidak ada data baru dari Google Sheets)', 'info');

                        // Hide status after 2 seconds
                        setTimeout(() => {
                            hideLoginLoadingStatus();
                        }, 2000);
                    }
                }).catch((error) => {
                    console.error('‚ùå Sinkronisasi gagal:', error);
                    showLoginLoadingStatus('‚ö†Ô∏è Sinkronisasi gagal, menggunakan data lokal', 'warning');

                    // Hide status after 3 seconds
                    setTimeout(() => {
                        hideLoginLoadingStatus();
                    }, 3000);
                });
            } else {
                console.log('‚ÑπÔ∏è Tidak ada konfigurasi Google Sheets, menggunakan data lokal');
            }
        });

        // Populate all dropdowns with configuration data
        function populateDropdowns() {
            // Populate class dropdowns
            const classSelects = ['classSelect', 'reportClass'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;

                // Clear existing options except first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }

                // Add configured classes
                classConfig.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });

                // Restore previous value if it still exists
                if (classConfig.includes(currentValue)) {
                    select.value = currentValue;
                }
            });

            // Populate subject dropdowns
            const subjectSelects = ['subjectSelect', 'reportSubject'];
            subjectSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;

                // Clear existing options except first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }

                // Add configured subjects
                subjectConfig.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });

                // Restore previous value if it still exists
                if (subjectConfig.includes(currentValue)) {
                    select.value = currentValue;
                }
            });

            // Populate time slot dropdown
            const timeSlotSelect = document.getElementById('timeSlot');
            const currentTimeSlot = timeSlotSelect.value;

            // Clear existing options
            timeSlotSelect.innerHTML = '';

            // Add configured time slots
            timeSlotConfig.forEach(timeSlot => {
                const option = document.createElement('option');
                option.value = timeSlot;
                option.textContent = timeSlot;
                timeSlotSelect.appendChild(option);
            });

            // Restore previous value if it still exists
            if (timeSlotConfig.includes(currentTimeSlot)) {
                timeSlotSelect.value = currentTimeSlot;
            } else if (timeSlotConfig.length > 0) {
                timeSlotSelect.value = timeSlotConfig[0];
            }
        }

        // Login function
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            console.log('Login attempt:', { username, password });
            console.log('Available users:', Object.keys(users));
            console.log('User data for', username, ':', users[username]);

            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.role === 'teacher' ? 'Guru' : 'Admin'})`;

                // Show/hide admin-only tabs based on user role
                updateNavigationVisibility();

                // Set default tab based on user role
                if (currentUser.role === 'admin') {
                    showTab('reports'); // Admin starts with reports tab
                } else {
                    showTab('attendance'); // Teachers start with attendance tab
                }
                showNotification('Login berhasil!', 'success');
            } else {
                console.log('Login failed. Checking all users:');
                Object.entries(users).forEach(([user, data]) => {
                    console.log(`${user}: password="${data.password}", role="${data.role}"`);
                });
                showNotification('Username atau password salah!', 'error');
            }
        }

        // Update navigation visibility based on user role
        function updateNavigationVisibility() {
            const attendanceNavTab = document.querySelector('button[onclick="showTab(\'attendance\')"]');
            const reportsNavTab = document.querySelector('button[onclick="showTab(\'reports\')"]');
            const studentsNavTab = document.getElementById('studentsNavTab');
            const settingsNavTab = document.getElementById('settingsNavTab');

            if (currentUser && currentUser.role === 'admin') {
                // Hide Input Absensi for admin
                attendanceNavTab.classList.add('hidden');
                // Show admin-only tabs
                studentsNavTab.classList.remove('hidden');
                settingsNavTab.classList.remove('hidden');
                // Show reports tab for admin
                reportsNavTab.classList.remove('hidden');
            } else {
                // Show Input Absensi for teachers
                attendanceNavTab.classList.remove('hidden');
                // Hide admin-only tabs for regular teachers
                studentsNavTab.classList.add('hidden');
                settingsNavTab.classList.add('hidden');
                // Show reports tab for teachers
                reportsNavTab.classList.remove('hidden');
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showNotification('Logout berhasil!', 'success');
        }

        // Tab navigation
        function showTab(tabName) {
            // Check if user has permission to access admin-only tabs
            if ((tabName === 'students' || tabName === 'settings') &&
                (!currentUser || currentUser.role !== 'admin')) {
                showNotification('Akses ditolak! Hanya admin yang dapat mengakses menu ini.', 'error');
                return;
            }

            // Check if admin tries to access attendance tab
            if (tabName === 'attendance' && currentUser && currentUser.role === 'admin') {
                showNotification('Akses ditolak! Admin tidak dapat mengakses menu Input Absensi.', 'error');
                return;
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('border-white');
                tab.classList.add('border-transparent');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Add active class to clicked nav tab
            if (event && event.target) {
                event.target.classList.remove('border-transparent');
                event.target.classList.add('border-white');
            } else {
                // Find and activate the correct nav tab when called programmatically
                const navTabs = document.querySelectorAll('.nav-tab');
                navTabs.forEach(tab => {
                    if (tab.onclick && tab.onclick.toString().includes(`'${tabName}'`)) {
                        tab.classList.remove('border-transparent');
                        tab.classList.add('border-white');
                    }
                });
            }

            // Load tab-specific data
            if (tabName === 'students') {
                loadStudentsData();
                loadStudentsQR();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Load students for attendance
        function loadStudents() {
            const selectedClass = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;
            const timeSlot = document.getElementById('timeSlot').value;
            const container = document.getElementById('studentsContainer');

            if (!selectedClass) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Pilih kelas untuk menampilkan daftar siswa</p>';
                return;
            }

            const students = studentsData[selectedClass] || [];

            // Check if all required fields are filled to validate existing attendance
            if (selectedClass && subject && date && timeSlot) {
                validateExistingAttendance(selectedClass, subject, date, timeSlot, students);
            } else {
                // Show students without validation
                displayStudentsList(students, {});
            }
        }

        // Validate existing attendance data
        function validateExistingAttendance(selectedClass, subject, date, timeSlot, students) {
            const container = document.getElementById('studentsContainer');

            // Show loading state
            container.innerHTML = '<div class="text-center py-8"><div class="text-blue-600">üîÑ Memeriksa data absensi yang sudah ada...</div></div>';

            // First check local data
            const existingLocalData = {};
            attendanceData.forEach(record => {
                if (record.class === selectedClass &&
                    record.subject === subject &&
                    record.date === date &&
                    record.time === timeSlot) {
                    existingLocalData[record.studentId] = {
                        status: record.status,
                        source: 'local'
                    };
                }
            });

            // If we have Google Sheets configuration, check there too
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const attendanceSheetUrl = localStorage.getItem('attendanceSheetUrl');

            if (webAppUrl && attendanceSheetUrl) {
                const studentIds = students.map(s => s.id);

                const payload = {
                    action: 'validateAttendance',
                    attendanceSheetUrl: attendanceSheetUrl,
                    validationData: {
                        studentIds: studentIds,
                        class: selectedClass,
                        subject: subject,
                        date: date,
                        timeSlot: timeSlot
                    }
                };

                // Try POST first, then GET as fallback
                fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors',
                    credentials: 'omit'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, conflicts: [] };
                            } else {
                                throw new Error('Response tidak valid');
                            }
                        }

                        if (data.success) {
                            const existingData = { ...existingLocalData };

                            // Add data from Google Sheets
                            if (data.conflicts && data.conflicts.length > 0) {
                                data.conflicts.forEach(conflict => {
                                    existingData[conflict.studentId] = {
                                        status: conflict.status,
                                        teacher: conflict.teacher,
                                        source: 'sheets'
                                    };
                                });
                            }

                            displayStudentsList(students, existingData);

                            // Show appropriate message and button
                            const hasExistingData = Object.keys(existingData).length > 0;
                            updateSaveButton(hasExistingData);

                            if (hasExistingData) {
                                showNotification(`Ditemukan data absensi yang sudah ada untuk ${Object.keys(existingData).length} siswa`, 'info');
                            }
                        } else {
                            console.error('Validation error:', data.message);
                            displayStudentsList(students, existingLocalData);
                            updateSaveButton(Object.keys(existingLocalData).length > 0);
                        }
                    })
                    .catch(error => {
                        console.error('POST failed, trying GET:', error);

                        // Fallback to GET method
                        const params = new URLSearchParams({
                            action: 'validateAttendance',
                            data: JSON.stringify(payload)
                        });

                        fetch(`${webAppUrl}?${params}`, {
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.text();
                            })
                            .then(text => {
                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch {
                                    if (text.includes('success') || text.includes('berhasil')) {
                                        data = { success: true, conflicts: [] };
                                    } else {
                                        throw new Error('Response tidak valid');
                                    }
                                }

                                if (data.success) {
                                    const existingData = { ...existingLocalData };

                                    // Add data from Google Sheets
                                    if (data.conflicts && data.conflicts.length > 0) {
                                        data.conflicts.forEach(conflict => {
                                            existingData[conflict.studentId] = {
                                                status: conflict.status,
                                                teacher: conflict.teacher,
                                                source: 'sheets'
                                            };
                                        });
                                    }

                                    displayStudentsList(students, existingData);

                                    // Show appropriate message and button
                                    const hasExistingData = Object.keys(existingData).length > 0;
                                    updateSaveButton(hasExistingData);

                                    if (hasExistingData) {
                                        showNotification(`Ditemukan data absensi yang sudah ada untuk ${Object.keys(existingData).length} siswa`, 'info');
                                    }
                                } else {
                                    console.error('Validation error via GET:', data.message);
                                    displayStudentsList(students, existingLocalData);
                                    updateSaveButton(Object.keys(existingLocalData).length > 0);
                                }
                            })
                            .catch(getError => {
                                console.error('Both POST and GET failed:', getError);
                                // Use local data only
                                displayStudentsList(students, existingLocalData);
                                updateSaveButton(Object.keys(existingLocalData).length > 0);
                            });
                    });
            } else {
                // No Google Sheets configuration, use local data only
                displayStudentsList(students, existingLocalData);
                updateSaveButton(Object.keys(existingLocalData).length > 0);
            }
        }

        // Display students list with existing data
        function displayStudentsList(students, existingData) {
            const container = document.getElementById('studentsContainer');
            container.innerHTML = '';

            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada siswa di kelas yang dipilih</p>';
                return;
            }

            students.forEach(student => {
                const existingRecord = existingData[student.id];
                const hasExistingData = !!existingRecord;

                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-4 border rounded-lg ${hasExistingData ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}`;

                let statusDisplay = 'Belum diisi';
                let statusClass = 'bg-gray-100 text-gray-600';

                if (hasExistingData) {
                    statusDisplay = existingRecord.status;
                    statusClass = `status-${existingRecord.status.toLowerCase()}`;

                    // Initialize temp attendance with existing data
                    if (!window.tempAttendance) window.tempAttendance = {};
                    window.tempAttendance[student.id] = existingRecord.status;
                }

                div.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between w-full gap-2 p-2 border-b">
                    <!-- Bagian Nama -->
                    <div class="flex-shrink-0 sm:w-64">
                        <p class="font-medium text-gray-900">${student.name}</p>
                        <p class="text-sm text-gray-500">Nis: ${student.id}</p>
                        ${hasExistingData ? `<p class="text-xs text-blue-600">üìã Data sudah ada${existingRecord.teacher ? ` (${existingRecord.teacher})` : ''}</p>` : ''}
                    </div>

                    <!-- Tombol -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setAttendanceStatus('${student.id}', 'Hadir')" 
                                class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition min-w-[64px] text-center">
                            Hadir
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'Sakit')" 
                                class="px-3 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition min-w-[64px] text-center">
                            Sakit
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'Izin')" 
                                class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition min-w-[64px] text-center">
                            Izin
                        </button>
                        <button onclick="setAttendanceStatus('${student.id}', 'Alpha')" 
                                class="px-3 py-1 text-xs rounded-full bg-red-100 text-red-800 hover:bg-red-200 transition min-w-[64px] text-center">
                            Alpha
                        </button>
                    </div>

                    <!-- Status -->
                    <div id="status-${student.id}" 
                        class="flex-shrink-0 px-3 py-1 text-xs rounded-full ${statusClass} text-center mt-2 sm:mt-0">
                        ${statusDisplay}
                    </div>
                </div>

                `;
                container.appendChild(div);
            });
        }

        // Update save button based on existing data
        function updateSaveButton(hasExistingData) {
            const saveButton = document.querySelector('button[onclick="saveAttendance()"]');
            if (saveButton) {
                if (hasExistingData) {
                    saveButton.textContent = 'Update Absensi';
                    saveButton.className = 'bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg';
                } else {
                    saveButton.textContent = 'Simpan Absensi';
                    saveButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg';
                }
            }
        }

        // Set attendance status
        function setAttendanceStatus(studentId, status) {
            const statusElement = document.getElementById(`status-${studentId}`);
            statusElement.textContent = status;
            statusElement.className = `ml-4 px-3 py-1 text-xs rounded-full status-${status.toLowerCase()}`;

            // Store in temporary data
            if (!window.tempAttendance) window.tempAttendance = {};
            window.tempAttendance[studentId] = status;
        }

        // Mark all present
        function markAllPresent() {
            const selectedClass = document.getElementById('classSelect').value;
            if (!selectedClass) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }

            const students = studentsData[selectedClass] || [];
            students.forEach(student => {
                setAttendanceStatus(student.id, 'Hadir');
            });

            showNotification('Semua siswa ditandai hadir!', 'success');
        }

        // Scanner functions
        function openScanner() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.style.display = 'block';

            // Initialize camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    const video = document.getElementById('video');
                    video.srcObject = stream;

                    // Initialize barcode reader
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                        if (result) {
                            handleScanResult(result.text);
                        }
                    });
                })
                .catch(err => {
                    showNotification('Tidak dapat mengakses kamera!', 'error');
                    closeScanner();
                });
        }

        function closeScanner() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.style.display = 'none';

            // Stop camera
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            // Stop code reader
            if (codeReader) {
                codeReader.reset();
            }
        }

        function handleScanResult(qrCode) {
            // Find student by QR code
            let foundStudent = null;
            let foundClass = null;

            for (const [className, students] of Object.entries(studentsData)) {
                const student = students.find(s => s.qr === qrCode);
                if (student) {
                    foundStudent = student;
                    foundClass = className;
                    break;
                }
            }

            if (foundStudent) {
                // Set class if not selected
                const classSelect = document.getElementById('classSelect');
                if (classSelect.value !== foundClass) {
                    classSelect.value = foundClass;
                    loadStudents();
                }

                // Mark as present
                setAttendanceStatus(foundStudent.id, 'Hadir');

                // Show scan result
                document.getElementById('scannedStudent').textContent = foundStudent.name;
                document.getElementById('scanResult').classList.remove('hidden');

                showNotification(`${foundStudent.name} berhasil dipindai dan ditandai hadir!`, 'success');
                closeScanner();

                // Hide scan result after 3 seconds
                setTimeout(() => {
                    document.getElementById('scanResult').classList.add('hidden');
                }, 3000);
            } else {
                showNotification('QR Code tidak valid!', 'error');
            }
        }

        // Save attendance with new sync method
        function saveAttendance() {
            const selectedClass = document.getElementById('classSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('attendanceDate').value;
            const timeSlot = document.getElementById('timeSlot').value;

            if (!selectedClass || !subject || !date) {
                showNotification('Lengkapi semua field terlebih dahulu!', 'error');
                return;
            }

            const students = studentsData[selectedClass] || [];

            if (students.length === 0) {
                showNotification('Tidak ada siswa di kelas yang dipilih!', 'error');
                return;
            }

            // Initialize tempAttendance if not exists
            if (!window.tempAttendance) {
                window.tempAttendance = {};
            }

            // Check if any attendance has been marked
            const hasAttendanceData = Object.keys(window.tempAttendance).length > 0;

            if (!hasAttendanceData) {
                // If no attendance marked, ask user if they want to mark all as Alpha
                if (!confirm('Belum ada absensi yang diisi. Apakah ingin menyimpan semua siswa sebagai Alpha?')) {
                    return;
                }
            }

            // Check if this is an update (existing data)
            const isUpdate = document.querySelector('button[onclick="saveAttendance()"]').textContent === 'Update Absensi';

            // Always remove existing records for this class, subject, date, and time before saving
            // This ensures update replaces data instead of adding duplicates
            const originalLength = attendanceData.length;
            attendanceData = attendanceData.filter(record =>
                !(record.class === selectedClass &&
                    record.subject === subject &&
                    record.date === date &&
                    record.time === timeSlot)
            );
            const removedCount = originalLength - attendanceData.length;

            const timestamp = new Date().toLocaleTimeString('id-ID');
            let savedCount = 0;
            const newAttendanceRecords = [];

            // Save each student's attendance
            students.forEach(student => {
                const status = window.tempAttendance[student.id] || 'Alpha';
                const attendanceRecord = {
                    id: Date.now() + Math.random() + savedCount,
                    date: date,
                    class: selectedClass,
                    studentName: student.name,
                    studentId: student.id,
                    subject: subject,
                    status: status,
                    time: timeSlot,
                    timestamp: timestamp,
                    teacher: currentUser ? currentUser.name : 'Unknown'
                };

                attendanceData.push(attendanceRecord);
                newAttendanceRecords.push(attendanceRecord);
                savedCount++;
            });

            // Save to localStorage
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

            // Clear temporary data
            window.tempAttendance = {};

            // Reset form and reload students to clear status displays
            loadStudents();

            if (isUpdate) {
                showNotification(`Absensi berhasil diperbarui untuk ${savedCount} siswa! (${removedCount} data lama dihapus)`, 'success');
            } else {
                showNotification(`Absensi berhasil disimpan untuk ${savedCount} siswa!`, 'success');
            }

            // For updates, sync all attendance data to ensure consistency
            // For new saves, just sync the new records
            if (localStorage.getItem('deploymentId') || localStorage.getItem('webAppUrl')) {
                if (isUpdate) {
                    // For updates, sync all data to ensure Google Sheets is consistent
                    syncAttendanceToSheets().catch(error => {
                        console.error('Auto sync failed:', error);
                        showNotification('Data tersimpan lokal, tapi gagal sync ke Google Sheets. Silakan sync manual.', 'error');
                    });
                } else {
                    // For new saves, just append the new records
                    syncNewAttendanceToSheets(newAttendanceRecords).catch(error => {
                        console.error('Auto sync failed:', error);
                        // Don't show error notification for auto sync failure
                        // User can manually sync if needed
                    });
                }
            }
        }

        // Sync new attendance data to Google Sheets (for real-time saving)
        function syncNewAttendanceToSheets(newRecords) {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const attendanceSheetUrl = localStorage.getItem('attendanceSheetUrl');

            if (!webAppUrl || !attendanceSheetUrl) {
                return Promise.resolve(); // No configuration, skip sync
            }

            console.log('üîÑ Menyimpan ke Google Sheets...', newRecords.length, 'records');
            console.log('üìã Records to sync:', newRecords);
            console.log('üåê Web App URL:', webAppUrl);
            console.log('üìä Sheet URL:', attendanceSheetUrl);

            const payload = {
                action: 'appendAttendance',
                attendanceSheetUrl: attendanceSheetUrl,
                attendanceData: newRecords
            };

            console.log('üì§ Payload being sent:', payload);

            // Enhanced sync with multiple fallback methods
            const tryMultipleMethods = async () => {
                let lastError = null;

                // Method 1: POST with JSON
                try {
                    console.log('üîÑ Mencoba POST dengan JSON...');
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json, text/plain, */*'
                        },
                        body: JSON.stringify(payload),
                        mode: 'no-cors', // Changed to no-cors to avoid CORS issues
                        credentials: 'omit',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('üìä POST response status:', response.status);

                    // For no-cors mode, we can't read the response, so assume success
                    if (response.type === 'opaque') {
                        console.log('‚úÖ POST request sent successfully (no-cors mode)');
                        showNotification('Data berhasil dikirim ke Google Sheets!', 'success');
                        return Promise.resolve({ success: true, message: 'Data berhasil dikirim' });
                    }

                    const text = await response.text();
                    console.log('üìÑ POST response text:', text);

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil') || text.includes('OK')) {
                            data = { success: true, message: 'Data absensi berhasil disimpan ke Google Sheets!' };
                        } else {
                            throw new Error('Response tidak valid dari POST');
                        }
                    }

                    if (data.success) {
                        console.log('‚úÖ POST sync berhasil:', data.message);
                        showNotification(data.message || 'Data berhasil disimpan ke Google Sheets!', 'success');
                        return Promise.resolve(data);
                    } else {
                        throw new Error(data.message || 'POST gagal');
                    }
                } catch (postError) {
                    console.error('‚ùå POST method failed:', postError);
                    lastError = postError;

                    // Method 2: JSONP-style approach
                    try {
                        console.log('üîÑ Mencoba JSONP method...');

                        return new Promise((resolve, reject) => {
                            const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                            const script = document.createElement('script');
                            let completed = false;

                            // Set up callback
                            window[callbackName] = function (data) {
                                if (!completed) {
                                    completed = true;
                                    cleanup();
                                    console.log('‚úÖ JSONP method berhasil:', data);
                                    showNotification(data.message || 'Data berhasil disimpan ke Google Sheets!', 'success');
                                    resolve(data);
                                }
                            };

                            const cleanup = () => {
                                if (script.parentNode) {
                                    script.parentNode.removeChild(script);
                                }
                                delete window[callbackName];
                            };

                            // Handle errors
                            script.onerror = () => {
                                if (!completed) {
                                    completed = true;
                                    cleanup();
                                    console.error('‚ùå JSONP method failed');
                                    reject(new Error('JSONP request failed'));
                                }
                            };

                            // Timeout
                            setTimeout(() => {
                                if (!completed) {
                                    completed = true;
                                    cleanup();
                                    console.error('‚ùå JSONP method timeout');
                                    reject(new Error('JSONP request timeout'));
                                }
                            }, 15000);

                            // Build URL with parameters
                            const params = new URLSearchParams({
                                action: 'appendAttendance',
                                attendanceSheetUrl: attendanceSheetUrl,
                                callback: callbackName,
                                data: JSON.stringify({ attendanceData: newRecords })
                            });

                            script.src = `${webAppUrl}?${params}`;
                            document.head.appendChild(script);
                        });

                    } catch (jsonpError) {
                        console.error('‚ùå JSONP method failed:', jsonpError);
                        lastError = jsonpError;

                        // Method 3: Iframe method (silent)
                        try {
                            console.log('üîÑ Menggunakan metode iframe untuk bypass CORS...');

                            return new Promise((resolve, reject) => {
                                const iframe = document.createElement('iframe');
                                iframe.style.display = 'none';
                                iframe.name = 'sync-frame-' + Date.now();
                                let completed = false;

                                const cleanup = () => {
                                    if (!completed) {
                                        completed = true;
                                        try {
                                            if (document.body.contains(iframe)) {
                                                document.body.removeChild(iframe);
                                            }
                                        } catch (cleanupError) {
                                            console.error('Cleanup error:', cleanupError);
                                        }
                                    }
                                };

                                iframe.onload = () => {
                                    console.log('‚úÖ Iframe sync completed');
                                    setTimeout(() => {
                                        cleanup();
                                        showNotification('Data telah dikirim ke Google Sheets. Periksa sheet untuk memastikan tersimpan.', 'success');
                                        resolve({ success: true, message: 'Data dikirim via iframe' });
                                    }, 2000);
                                };

                                iframe.onerror = () => {
                                    console.error('‚ùå Iframe error');
                                    cleanup();
                                    reject(new Error('Iframe method failed'));
                                };

                                // Timeout
                                setTimeout(() => {
                                    if (!completed) {
                                        console.log('‚è∞ Iframe timeout, assuming success');
                                        cleanup();
                                        showNotification('Data telah dikirim ke Google Sheets (timeout). Periksa sheet untuk memastikan.', 'info');
                                        resolve({ success: true, message: 'Data dikirim (timeout)' });
                                    }
                                }, 10000);

                                // Create form to submit to iframe
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = webAppUrl;
                                form.target = iframe.name;
                                form.style.display = 'none';

                                // Add payload as form data
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'payload';
                                input.value = JSON.stringify(payload);
                                form.appendChild(input);

                                document.body.appendChild(iframe);
                                document.body.appendChild(form);
                                form.submit();

                                // Clean up form immediately
                                setTimeout(() => {
                                    if (document.body.contains(form)) {
                                        document.body.removeChild(form);
                                    }
                                }, 1000);
                            });

                        } catch (iframeError) {
                            console.error('‚ùå Iframe method failed:', iframeError);
                            lastError = iframeError;

                            // Final fallback: Show user-friendly message
                            console.error('‚ùå Semua metode sync gagal');
                            showNotification('Gagal menyimpan ke Google Sheets. Data tersimpan lokal.', 'error');
                            return Promise.reject(lastError || new Error('All sync methods failed'));
                        }
                    }
                }
            };

            return tryMultipleMethods();
        }

        // Generate report
        function generateReport() {
            const reportClass = document.getElementById('reportClass').value;
            const reportSubject = document.getElementById('reportSubject').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const status = document.getElementById('reportStatus').value;

            let filteredData = attendanceData;

            // Apply filters
            if (reportClass) {
                filteredData = filteredData.filter(record => record.class === reportClass);
            }

            if (reportSubject) {
                filteredData = filteredData.filter(record => record.subject === reportSubject);
            }

            if (startDate) {
                filteredData = filteredData.filter(record => record.date >= startDate);
            }

            if (endDate) {
                filteredData = filteredData.filter(record => record.date <= endDate);
            }

            if (status) {
                filteredData = filteredData.filter(record => record.status === status);
            }

            // Update statistics
            const stats = {
                present: filteredData.filter(r => r.status === 'Hadir').length,
                sick: filteredData.filter(r => r.status === 'Sakit').length,
                permission: filteredData.filter(r => r.status === 'Izin').length,
                absent: filteredData.filter(r => r.status === 'Alpha').length
            };

            document.getElementById('totalPresent').textContent = stats.present;
            document.getElementById('totalSick').textContent = stats.sick;
            document.getElementById('totalPermission').textContent = stats.permission;
            document.getElementById('totalAbsent').textContent = stats.absent;

            // Update table
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">Tidak ada data sesuai filter</td></tr>';
            } else {
                filteredData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.class}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.studentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.subject}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-${record.status.toLowerCase()}">
                                ${record.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.teacher}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            showNotification('Laporan berhasil di-generate!', 'success');
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text('Laporan Absensi Siswa', 20, 20);

            // Get filtered data
            const tbody = document.getElementById('reportTableBody');
            const rows = tbody.querySelectorAll('tr');

            let yPosition = 40;
            doc.setFontSize(10);

            // Add header
            doc.text('Tanggal | Kelas | Nama Siswa | Status | Guru', 20, yPosition);
            yPosition += 10;

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const text = `${cells[0].textContent} | ${cells[1].textContent} | ${cells[2].textContent} | ${cells[5].textContent.trim()} | ${cells[7].textContent}`;
                    doc.text(text, 20, yPosition);
                    yPosition += 8;

                    if (yPosition > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }
            });

            doc.save('laporan-absensi.pdf');
            showNotification('Laporan PDF berhasil diunduh!', 'success');
        }

        // Export to Excel
        function exportToExcel() {
            // Get filtered data from the table
            const tbody = document.getElementById('reportTableBody');
            const rows = tbody.querySelectorAll('tr');

            // Check if there's data to export
            if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('Tidak ada data'))) {
                showNotification('Tidak ada data untuk diekspor!', 'error');
                return;
            }

            // Prepare data for Excel
            const excelData = [];

            // Add header row
            excelData.push([
                'Tanggal',
                'Kelas',
                'Nama Siswa',
                'ID Siswa',
                'Mata Pelajaran',
                'Status',
                'Jam Pelajaran',
                'Guru'
            ]);

            // Add data rows
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) { // Skip empty state rows
                    const rowData = [
                        cells[0].textContent.trim(), // Tanggal
                        cells[1].textContent.trim(), // Kelas
                        cells[2].textContent.trim(), // Nama Siswa
                        cells[3].textContent.trim(), // ID Siswa
                        cells[4].textContent.trim(), // Mata Pelajaran
                        cells[5].textContent.trim(), // Status (clean from span)
                        cells[6].textContent.trim(), // Jam
                        cells[7].textContent.trim()  // Guru
                    ];
                    excelData.push(rowData);
                }
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Set column widths
            const colWidths = [
                { wch: 12 }, // Tanggal
                { wch: 10 }, // Kelas
                { wch: 25 }, // Nama Siswa
                { wch: 12 }, // ID Siswa
                { wch: 18 }, // Mata Pelajaran
                { wch: 8 },  // Status
                { wch: 15 }, // Jam
                { wch: 20 }  // Guru
            ];
            ws['!cols'] = colWidths;

            // Style the header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "2563EB" } }, // Blue background
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header styling
            for (let col = 0; col < 8; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = headerStyle;
            }

            // Add conditional formatting for status column
            for (let row = 1; row < excelData.length; row++) {
                const statusCellAddress = XLSX.utils.encode_cell({ r: row, c: 5 });
                if (!ws[statusCellAddress]) continue;

                const status = excelData[row][5];
                let statusStyle = { alignment: { horizontal: "center" } };

                switch (status) {
                    case 'Hadir':
                        statusStyle.fill = { fgColor: { rgb: "DCFCE7" } }; // Light green
                        statusStyle.font = { color: { rgb: "166534" } }; // Dark green
                        break;
                    case 'Sakit':
                        statusStyle.fill = { fgColor: { rgb: "FEF3C7" } }; // Light yellow
                        statusStyle.font = { color: { rgb: "92400E" } }; // Dark yellow
                        break;
                    case 'Izin':
                        statusStyle.fill = { fgColor: { rgb: "DBEAFE" } }; // Light blue
                        statusStyle.font = { color: { rgb: "1E40AF" } }; // Dark blue
                        break;
                    case 'Alpha':
                        statusStyle.fill = { fgColor: { rgb: "FEE2E2" } }; // Light red
                        statusStyle.font = { color: { rgb: "991B1B" } }; // Dark red
                        break;
                }

                ws[statusCellAddress].s = statusStyle;
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Absensi");

            // Generate filename with current date and filters
            const reportClass = document.getElementById('reportClass').value;
            const reportSubject = document.getElementById('reportSubject').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const status = document.getElementById('reportStatus').value;

            let filename = 'Laporan-Absensi';

            if (reportClass) {
                filename += `-${reportClass}`;
            }

            if (reportSubject) {
                filename += `-${reportSubject.replace(/\s+/g, '-')}`;
            }

            if (startDate && endDate) {
                if (startDate === endDate) {
                    filename += `-${startDate}`;
                } else {
                    filename += `-${startDate}_${endDate}`;
                }
            } else if (startDate) {
                filename += `-dari-${startDate}`;
            } else if (endDate) {
                filename += `-sampai-${endDate}`;
            }

            if (status) {
                filename += `-${status}`;
            }

            filename += '.xlsx';

            // Save the file
            XLSX.writeFile(wb, filename);

            // Show success notification with statistics
            const totalRecords = excelData.length - 1; // Exclude header
            const stats = {
                present: excelData.filter(row => row[5] === 'Hadir').length,
                sick: excelData.filter(row => row[5] === 'Sakit').length,
                permission: excelData.filter(row => row[5] === 'Izin').length,
                absent: excelData.filter(row => row[5] === 'Alpha').length
            };

            showNotification(
                `Excel berhasil diunduh! ${totalRecords} record (Hadir: ${stats.present}, Sakit: ${stats.sick}, Izin: ${stats.permission}, Alpha: ${stats.absent})`,
                'success'
            );
        }

        // Google Apps Script integration functions
        function syncToGoogleSheets() {
            syncAttendanceToSheets();
        }

        function syncAttendanceToSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const attendanceSheetUrl = localStorage.getItem('attendanceSheetUrl');

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return Promise.reject('No web app URL');
            }

            if (!attendanceSheetUrl) {
                showNotification('URL Sheet Absensi belum diatur!', 'error');
                return Promise.reject('No attendance sheet URL');
            }

            if (!attendanceData || attendanceData.length === 0) {
                showNotification('Tidak ada data absensi untuk disinkronkan!', 'error');
                return Promise.reject('No attendance data');
            }

            showNotification('Sedang menyinkronkan data absensi...', 'info');

            const payload = {
                action: 'syncAttendance',
                attendanceSheetUrl: attendanceSheetUrl,
                attendanceData: attendanceData
            };

            console.log('üîÑ Syncing attendance data:', {
                action: payload.action,
                sheetUrl: payload.attendanceSheetUrl,
                recordCount: payload.attendanceData.length,
                webAppUrl: webAppUrl
            });

            // Enhanced sync with multiple methods and better error handling
            const tryMultipleMethods = async () => {
                let lastError = null;

                // Method 1: POST with JSON and CORS
                try {
                    console.log('üîÑ Mencoba POST dengan JSON (CORS)...');
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json, text/plain, */*'
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        credentials: 'omit',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('üìä POST CORS response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    console.log('üìÑ POST CORS response text:', text.substring(0, 500) + (text.length > 500 ? '...' : ''));

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        console.log('JSON parse failed, checking for success indicators...');
                        if (text.includes('success') || text.includes('berhasil') || text.includes('OK') || text.includes('disinkronkan')) {
                            data = { success: true, message: `Data absensi berhasil disinkronkan! (${attendanceData.length} record)` };
                        } else {
                            throw new Error('Response tidak valid dari POST CORS: ' + text.substring(0, 200));
                        }
                    }

                    if (data.success) {
                        console.log('‚úÖ POST CORS sync berhasil:', data.message);
                        showNotification(data.message || `Data absensi berhasil disinkronkan! (${attendanceData.length} record)`, 'success');
                        return Promise.resolve(data);
                    } else {
                        throw new Error(data.message || 'POST CORS gagal: ' + JSON.stringify(data));
                    }

                } catch (corsError) {
                    console.error('‚ùå POST CORS method failed:', corsError);
                    lastError = corsError;

                    // Method 2: POST with no-cors mode
                    try {
                        console.log('üîÑ Mencoba POST dengan no-cors mode...');
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 25000);

                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload),
                            mode: 'no-cors',
                            credentials: 'omit',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        console.log('üìä POST no-cors response:', response);

                        // For no-cors mode, we can't read the response, but if no error thrown, assume success
                        if (response.type === 'opaque') {
                            console.log('‚úÖ POST no-cors request sent successfully');
                            showNotification(`Data absensi berhasil dikirim ke Google Sheets! (${attendanceData.length} record)`, 'success');
                            return Promise.resolve({ success: true, message: 'Data berhasil dikirim (no-cors)' });
                        }

                    } catch (noCorsError) {
                        console.error('‚ùå POST no-cors method failed:', noCorsError);
                        lastError = noCorsError;

                        // Method 3: POST with form data
                        try {
                            console.log('üîÑ Mencoba POST dengan form data...');
                            const formData = new FormData();
                            formData.append('payload', JSON.stringify(payload));

                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 25000);

                            const response = await fetch(webAppUrl, {
                                method: 'POST',
                                body: formData,
                                mode: 'cors',
                                credentials: 'omit',
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);
                            console.log('üìä POST form response status:', response.status);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const text = await response.text();
                            console.log('üìÑ POST form response text:', text.substring(0, 500) + (text.length > 500 ? '...' : ''));

                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (parseError) {
                                if (text.includes('success') || text.includes('berhasil') || text.includes('OK') || text.includes('disinkronkan')) {
                                    data = { success: true, message: `Data absensi berhasil disinkronkan! (${attendanceData.length} record)` };
                                } else {
                                    throw new Error('Response tidak valid dari POST form: ' + text.substring(0, 200));
                                }
                            }

                            if (data.success) {
                                console.log('‚úÖ POST form sync berhasil:', data.message);
                                showNotification(data.message || `Data absensi berhasil disinkronkan! (${attendanceData.length} record)`, 'success');
                                return Promise.resolve(data);
                            } else {
                                throw new Error(data.message || 'POST form gagal: ' + JSON.stringify(data));
                            }

                        } catch (formError) {
                            console.error('‚ùå POST form method failed:', formError);
                            lastError = formError;

                            // Method 4: GET with parameters (if data is small enough)
                            try {
                                console.log('üîÑ Mencoba GET dengan parameters...');

                                // Create smaller payload for GET request
                                const getPayload = {
                                    action: 'syncAttendance',
                                    attendanceSheetUrl: attendanceSheetUrl,
                                    attendanceData: attendanceData.slice(0, 50) // Limit to first 50 records for GET
                                };

                                const params = new URLSearchParams({
                                    action: getPayload.action,
                                    attendanceSheetUrl: getPayload.attendanceSheetUrl,
                                    data: JSON.stringify({ attendanceData: getPayload.attendanceData })
                                });

                                const getUrl = `${webAppUrl}?${params}`;
                                console.log('üîó GET URL length:', getUrl.length);

                                // Check URL length limit
                                if (getUrl.length > 7000) {
                                    throw new Error('Data terlalu besar untuk GET request');
                                }

                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 25000);

                                const response = await fetch(getUrl, {
                                    method: 'GET',
                                    mode: 'cors',
                                    credentials: 'omit',
                                    signal: controller.signal
                                });

                                clearTimeout(timeoutId);
                                console.log('üìä GET response status:', response.status);

                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }

                                const text = await response.text();
                                console.log('üìÑ GET response text:', text.substring(0, 500) + (text.length > 500 ? '...' : ''));

                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch (parseError) {
                                    if (text.includes('success') || text.includes('berhasil') || text.includes('OK') || text.includes('disinkronkan')) {
                                        data = { success: true, message: `Sebagian data absensi berhasil disinkronkan! (${getPayload.attendanceData.length} dari ${attendanceData.length} record)` };
                                    } else {
                                        throw new Error('Response tidak valid dari GET: ' + text.substring(0, 200));
                                    }
                                }

                                if (data.success) {
                                    console.log('‚úÖ GET sync berhasil (partial):', data.message);
                                    if (getPayload.attendanceData.length < attendanceData.length) {
                                        showNotification(`Sebagian data berhasil disinkronkan (${getPayload.attendanceData.length}/${attendanceData.length}). Gunakan metode lain untuk data lengkap.`, 'info');
                                    } else {
                                        showNotification(data.message || `Data absensi berhasil disinkronkan! (${attendanceData.length} record)`, 'success');
                                    }
                                    return Promise.resolve(data);
                                } else {
                                    throw new Error(data.message || 'GET gagal: ' + JSON.stringify(data));
                                }

                            } catch (getError) {
                                console.error('‚ùå GET method failed:', getError);
                                lastError = getError;

                                // Method 5: Iframe method (final fallback)
                                try {
                                    console.log('üîÑ Menggunakan metode iframe sebagai fallback terakhir...');

                                    return new Promise((resolve, reject) => {
                                        const iframe = document.createElement('iframe');
                                        iframe.style.display = 'none';
                                        iframe.name = 'sync-frame-' + Date.now();
                                        let completed = false;

                                        const cleanup = () => {
                                            if (!completed) {
                                                completed = true;
                                                try {
                                                    if (document.body.contains(iframe)) {
                                                        document.body.removeChild(iframe);
                                                    }
                                                } catch (cleanupError) {
                                                    console.error('Cleanup error:', cleanupError);
                                                }
                                            }
                                        };

                                        iframe.onload = () => {
                                            console.log('‚úÖ Iframe sync completed');
                                            setTimeout(() => {
                                                cleanup();
                                                showNotification(`Data absensi telah dikirim ke Google Sheets (${attendanceData.length} record). Periksa sheet untuk memastikan tersimpan.`, 'success');
                                                resolve({ success: true, message: 'Data dikirim via iframe' });
                                            }, 3000);
                                        };

                                        iframe.onerror = () => {
                                            console.error('‚ùå Iframe error');
                                            cleanup();
                                            reject(new Error('Iframe method failed'));
                                        };

                                        // Timeout with success assumption
                                        setTimeout(() => {
                                            if (!completed) {
                                                console.log('‚è∞ Iframe timeout, assuming success');
                                                cleanup();
                                                showNotification(`Data absensi telah dikirim ke Google Sheets (${attendanceData.length} record, timeout). Periksa sheet untuk memastikan.`, 'info');
                                                resolve({ success: true, message: 'Data dikirim (timeout)' });
                                            }
                                        }, 20000);

                                        // Create form to submit to iframe
                                        const form = document.createElement('form');
                                        form.method = 'POST';
                                        form.action = webAppUrl;
                                        form.target = iframe.name;
                                        form.style.display = 'none';

                                        // Add payload as form data
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = 'payload';
                                        input.value = JSON.stringify(payload);
                                        form.appendChild(input);

                                        document.body.appendChild(iframe);
                                        document.body.appendChild(form);
                                        form.submit();

                                        // Clean up form
                                        setTimeout(() => {
                                            if (document.body.contains(form)) {
                                                document.body.removeChild(form);
                                            }
                                        }, 1000);
                                    });

                                } catch (iframeError) {
                                    console.error('‚ùå Iframe method failed:', iframeError);
                                    lastError = iframeError;

                                    // Final error with detailed troubleshooting
                                    console.error('‚ùå Semua metode sync gagal');
                                    console.error('Troubleshooting info:');
                                    console.error('- Web App URL:', webAppUrl);
                                    console.error('- Sheet URL:', attendanceSheetUrl);
                                    console.error('- Data count:', attendanceData.length);
                                    console.error('- Last error:', lastError);

                                    showNotification(`Gagal menyinkronkan data absensi. Periksa konfigurasi Apps Script dan coba lagi.`, 'error');
                                    return Promise.reject(lastError || new Error('All sync methods failed'));
                                }
                            }
                        }
                    }
                }
            };

            return tryMultipleMethods();
        }

        function syncStudentsToSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const studentsSheetUrl = localStorage.getItem('studentsSheetUrl');

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return Promise.reject('No web app URL');
            }

            if (!studentsSheetUrl) {
                showNotification('URL Sheet Data Siswa belum diatur!', 'error');
                return Promise.reject('No students sheet URL');
            }

            showNotification('Sedang menyinkronkan data siswa...', 'info');

            const payload = {
                action: 'syncStudents',
                studentsSheetUrl: studentsSheetUrl,
                studentsData: studentsData
            };

            // Try POST first, then GET as fallback
            return fetch(webAppUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, message: 'Data siswa berhasil disinkronkan!' };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    if (data.success) {
                        showNotification(data.message || 'Data siswa berhasil disinkronkan!', 'success');
                        return Promise.resolve(data);
                    } else {
                        showNotification(`Error: ${data.message}`, 'error');
                        return Promise.reject(data.message);
                    }
                })
                .catch(error => {
                    console.error('POST failed, trying GET:', error);

                    // Fallback to GET method
                    const params = new URLSearchParams({
                        action: 'syncStudents',
                        data: JSON.stringify({
                            studentsSheetUrl: studentsSheetUrl,
                            studentsData: studentsData
                        })
                    });

                    return fetch(`${webAppUrl}?${params}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, message: 'Data siswa berhasil disinkronkan!' };
                                } else {
                                    throw new Error('Response tidak valid');
                                }
                            }

                            if (data.success) {
                                showNotification(data.message || 'Data siswa berhasil disinkronkan!', 'success');
                                return Promise.resolve(data);
                            } else {
                                showNotification(`Error: ${data.message}`, 'error');
                                return Promise.reject(data.message);
                            }
                        })
                        .catch(getError => {
                            console.error('Both POST and GET failed:', getError);
                            showNotification('Gagal menyinkronkan data siswa!', 'error');
                            return Promise.reject(getError);
                        });
                });
        }



        // Load users data from Google Sheets
        function loadUsersFromSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');

            if (!webAppUrl || !teachersSheetUrl) {
                return Promise.resolve(); // No configuration, use local data
            }

            const payload = {
                action: 'loadTeachers',
                teachersSheetUrl: teachersSheetUrl
            };

            // Try POST first, then GET as fallback
            return fetch(webAppUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, data: {} };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    if (data.success && data.data && Object.keys(data.data).length > 0) {
                        // Update users data with data from sheets
                        users = { ...users, ...data.data };
                        localStorage.setItem('usersData', JSON.stringify(users));
                        console.log('Users data loaded from Google Sheets:', Object.keys(users));
                        showNotification('Data guru berhasil dimuat dari Google Sheets!', 'success');
                    }

                    return Promise.resolve();
                })
                .catch(error => {
                    console.error('POST failed for users, trying GET:', error);

                    // Fallback to GET method
                    const params = new URLSearchParams({
                        action: 'loadTeachers',
                        data: JSON.stringify(payload)
                    });

                    return fetch(`${webAppUrl}?${params}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, data: {} };
                                } else {
                                    throw new Error('Response tidak valid');
                                }
                            }

                            if (data.success && data.data && Object.keys(data.data).length > 0) {
                                // Update users data with data from sheets
                                users = { ...users, ...data.data };
                                localStorage.setItem('usersData', JSON.stringify(users));
                                console.log('Users data loaded from Google Sheets via GET:', Object.keys(users));
                                showNotification('Data guru berhasil dimuat dari Google Sheets!', 'success');
                            }

                            return Promise.resolve();
                        })
                        .catch(getError => {
                            console.error('Both POST and GET failed for users:', getError);
                            return Promise.resolve(); // Don't fail, use local data
                        });
                });
        }

        // Show loading status on login page
        function showLoginLoadingStatus(message, type) {

            // Create or update loading status element
            let statusElement = document.getElementById('loginLoadingStatus');

            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'loginLoadingStatus';
                statusElement.className = 'mt-4 p-3 rounded-lg text-sm text-center';

                // Insert after the login form
                const loginForm = document.querySelector('#loginScreen form');
                if (loginForm && loginForm.parentNode) {
                    loginForm.parentNode.insertBefore(statusElement, loginForm.nextSibling);
                }
            }

            // Set appropriate styling based on type
            let bgClass = 'bg-blue-50 text-blue-700 border border-blue-200';
            if (type === 'success') {
                bgClass = 'bg-green-50 text-green-700 border border-green-200';
            } else if (type === 'warning') {
                bgClass = 'bg-yellow-50 text-yellow-700 border border-yellow-200';
            } else if (type === 'error') {
                bgClass = 'bg-red-50 text-red-700 border border-red-200';
            }

            statusElement.className = `mt-4 p-3 rounded-lg text-sm text-center ${bgClass}`;
            statusElement.textContent = message;
            statusElement.style.display = 'block';




        }

        // Hide loading status on login page
        function hideLoginLoadingStatus() {
            const statusElement = document.getElementById('loginLoadingStatus');
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        // Enhanced version for startup sync with better user feedback
        function loadDataFromSheetsOnStartup() {
            const webAppUrl = localStorage.getItem('webAppUrl') || defaultConfig.webAppUrl;

            if (!webAppUrl) {
                return Promise.resolve({ loadedCount: 0, message: 'No web app URL configured' });
            }

            const studentsSheetUrl = localStorage.getItem('studentsSheetUrl') || defaultConfig.studentsSheetUrl;
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl') || defaultConfig.teachersSheetUrl;
            const subjectsSheetUrl = localStorage.getItem('subjectsSheetUrl') || defaultConfig.subjectsSheetUrl;
            const classesSheetUrl = localStorage.getItem('classesSheetUrl') || defaultConfig.classesSheetUrl;
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            const loadPromises = [];

            // Helper function to make request with enhanced error handling
            const makeLoadRequestStartup = async (payload, type) => {
                try {
                    console.log(`üîÑ Loading ${type} data...`);

                    // Try POST first with shorter timeout for startup
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        credentials: 'omit',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    let data;

                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, data: type === 'students' ? {} : [] };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    console.log(`‚úÖ ${type} data loaded successfully`);
                    return { type, data };

                } catch (error) {
                    console.log(`‚ö†Ô∏è Failed to load ${type} data:`, error.message);

                    // Try GET method as fallback with shorter timeout
                    try {
                        const params = new URLSearchParams({
                            action: payload.action,
                            data: JSON.stringify(payload)
                        });

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout

                        const response = await fetch(`${webAppUrl}?${params}`, {
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const text = await response.text();
                        let data;

                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, data: type === 'students' ? {} : [] };
                            } else {
                                throw new Error('Response tidak valid');
                            }
                        }

                        console.log(`‚úÖ ${type} data loaded via GET fallback`);
                        return { type, data };
                    } catch (getError) {
                        console.log(`‚ùå Both POST and GET failed for ${type}:`, getError.message);
                        return { type, data: { success: false, data: type === 'students' ? {} : [] } };
                    }
                }
            };

            // Load students if URL provided
            if (studentsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestStartup({
                        action: 'loadStudents',
                        studentsSheetUrl: studentsSheetUrl
                    }, 'students')
                );
            }

            // Load teachers if URL provided
            if (teachersSheetUrl) {
                loadPromises.push(
                    makeLoadRequestStartup({
                        action: 'loadTeachers',
                        teachersSheetUrl: teachersSheetUrl
                    }, 'teachers')
                );
            }

            // Load subjects if URL provided
            if (subjectsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestStartup({
                        action: 'loadSubjects',
                        subjectsSheetUrl: subjectsSheetUrl
                    }, 'subjects')
                );
            }

            // Load classes if URL provided
            if (classesSheetUrl) {
                loadPromises.push(
                    makeLoadRequestStartup({
                        action: 'loadClasses',
                        classesSheetUrl: classesSheetUrl
                    }, 'classes')
                );
            }

            // Load time slots if URL provided
            if (timeSlotsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestStartup({
                        action: 'loadTimeSlots',
                        timeSlotsSheetUrl: timeSlotsSheetUrl
                    }, 'timeSlots')
                );
            }

            if (loadPromises.length === 0) {
                return Promise.resolve({ loadedCount: 0, message: 'No sheets configured for loading' });
            }

            return Promise.all(loadPromises)
                .then(results => {
                    let loadedCount = 0;
                    const loadedTypes = [];

                    results.forEach(result => {
                        if (result.data.success) {
                            switch (result.type) {
                                case 'students':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        studentsData = result.data.data;
                                        localStorage.setItem('studentsData', JSON.stringify(studentsData));
                                        loadedCount++;
                                        loadedTypes.push('Data Siswa');
                                    }
                                    break;
                                case 'teachers':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        // Merge with existing users, don't replace completely
                                        Object.assign(users, result.data.data);
                                        loadedCount++;
                                        loadedTypes.push('Data Guru');
                                    }
                                    break;
                                case 'subjects':
                                    if (result.data.data && result.data.data.length > 0) {
                                        subjectConfig = result.data.data;
                                        localStorage.setItem('subjectConfig', JSON.stringify(subjectConfig));
                                        loadedCount++;
                                        loadedTypes.push('Mata Pelajaran');
                                    }
                                    break;
                                case 'classes':
                                    if (result.data.data && result.data.data.length > 0) {
                                        classConfig = result.data.data;
                                        localStorage.setItem('classConfig', JSON.stringify(classConfig));
                                        loadedCount++;
                                        loadedTypes.push('Data Kelas');
                                    }
                                    break;
                                case 'timeSlots':
                                    if (result.data.data && result.data.data.length > 0) {
                                        timeSlotConfig = result.data.data;
                                        localStorage.setItem('timeSlotConfig', JSON.stringify(timeSlotConfig));
                                        loadedCount++;
                                        loadedTypes.push('Jam Pelajaran');
                                    }
                                    break;
                            }
                        }
                    });

                    return {
                        loadedCount,
                        loadedTypes,
                        message: loadedCount > 0 ? `Berhasil memuat: ${loadedTypes.join(', ')}` : 'Tidak ada data baru'
                    };
                })
                .catch(error => {
                    console.error('Startup sync error:', error);
                    return Promise.reject({
                        loadedCount: 0,
                        message: `Gagal sinkronisasi: ${error.message}`
                    });
                });
        }

        // Silent version of loadDataFromSheets (no error notifications)
        function loadDataFromSheetsSilent() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);

            if (!webAppUrl) {
                return Promise.resolve(0); // No configuration, use local data
            }

            const studentsSheetUrl = localStorage.getItem('studentsSheetUrl');
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');
            const subjectsSheetUrl = localStorage.getItem('subjectsSheetUrl');
            const classesSheetUrl = localStorage.getItem('classesSheetUrl');
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            const loadPromises = [];

            // Helper function to make request with POST and GET fallback (silent)
            const makeLoadRequestSilent = async (payload, type) => {
                try {
                    // Try POST first
                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        credentials: 'omit'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    let data;

                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, data: type === 'students' ? {} : [] };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    return { type, data };

                } catch (error) {
                    // Silently try GET method
                    try {
                        const params = new URLSearchParams({
                            action: payload.action,
                            data: JSON.stringify(payload)
                        });

                        const response = await fetch(`${webAppUrl}?${params}`, {
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const text = await response.text();
                        let data;

                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, data: type === 'students' ? {} : [] };
                            } else {
                                throw new Error('Response tidak valid');
                            }
                        }

                        return { type, data };
                    } catch (getError) {
                        // Silently fail - don't throw error
                        console.log(`Silent load failed for ${type}:`, getError.message);
                        return { type, data: { success: false, data: type === 'students' ? {} : [] } };
                    }
                }
            };

            // Load students if URL provided
            if (studentsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestSilent({
                        action: 'loadStudents',
                        studentsSheetUrl: studentsSheetUrl
                    }, 'students')
                );
            }

            // Load teachers if URL provided
            if (teachersSheetUrl) {
                loadPromises.push(
                    makeLoadRequestSilent({
                        action: 'loadTeachers',
                        teachersSheetUrl: teachersSheetUrl
                    }, 'teachers')
                );
            }

            // Load subjects if URL provided
            if (subjectsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestSilent({
                        action: 'loadSubjects',
                        subjectsSheetUrl: subjectsSheetUrl
                    }, 'subjects')
                );
            }

            // Load classes if URL provided
            if (classesSheetUrl) {
                loadPromises.push(
                    makeLoadRequestSilent({
                        action: 'loadClasses',
                        classesSheetUrl: classesSheetUrl
                    }, 'classes')
                );
            }

            // Load time slots if URL provided
            if (timeSlotsSheetUrl) {
                loadPromises.push(
                    makeLoadRequestSilent({
                        action: 'loadTimeSlots',
                        timeSlotsSheetUrl: timeSlotsSheetUrl
                    }, 'timeSlots')
                );
            }

            if (loadPromises.length === 0) {
                return Promise.resolve(0); // No URLs configured
            }

            return Promise.all(loadPromises)
                .then(results => {
                    let loadedCount = 0;

                    results.forEach(result => {
                        if (result.data.success) {
                            switch (result.type) {
                                case 'students':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        studentsData = result.data.data;
                                        localStorage.setItem('studentsData', JSON.stringify(studentsData));
                                        loadedCount++;
                                    }
                                    break;
                                case 'teachers':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        Object.assign(users, result.data.data);
                                        loadedCount++;
                                    }
                                    break;
                                case 'subjects':
                                    if (result.data.data && result.data.data.length > 0) {
                                        subjectConfig = result.data.data;
                                        localStorage.setItem('subjectConfig', JSON.stringify(subjectConfig));
                                        loadedCount++;
                                    }
                                    break;
                                case 'classes':
                                    if (result.data.data && result.data.data.length > 0) {
                                        classConfig = result.data.data;
                                        localStorage.setItem('classConfig', JSON.stringify(classConfig));
                                        loadedCount++;
                                    }
                                    break;
                                case 'timeSlots':
                                    if (result.data.data && result.data.data.length > 0) {
                                        timeSlotConfig = result.data.data;
                                        localStorage.setItem('timeSlotConfig', JSON.stringify(timeSlotConfig));
                                        loadedCount++;
                                    }
                                    break;
                            }
                        }
                    });

                    return loadedCount;
                })
                .catch(error => {
                    // Silent failure - just return 0
                    console.log('Silent data load failed:', error.message);
                    return 0;
                });
        }

        function loadDataFromSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);

            if (!webAppUrl) {
                return Promise.resolve(0); // No configuration, use local data
            }

            const studentsSheetUrl = localStorage.getItem('studentsSheetUrl');
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');
            const subjectsSheetUrl = localStorage.getItem('subjectsSheetUrl');
            const classesSheetUrl = localStorage.getItem('classesSheetUrl');
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            const loadPromises = [];

            // Helper function to make request with POST and GET fallback
            const makeLoadRequest = async (payload, type) => {
                try {
                    // Try POST first
                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        credentials: 'omit'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    let data;

                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, data: type === 'students' ? {} : [] };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    return { type, data };

                } catch (error) {
                    console.error(`POST failed for ${type}, trying GET:`, error);

                    // Fallback to GET method
                    const params = new URLSearchParams({
                        action: payload.action,
                        data: JSON.stringify(payload)
                    });

                    const response = await fetch(`${webAppUrl}?${params}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    let data;

                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, data: type === 'students' ? {} : [] };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    return { type, data };
                }
            };

            // Load students if URL provided
            if (studentsSheetUrl) {
                loadPromises.push(
                    makeLoadRequest({
                        action: 'loadStudents',
                        studentsSheetUrl: studentsSheetUrl
                    }, 'students')
                );
            }

            // Load teachers if URL provided
            if (teachersSheetUrl) {
                loadPromises.push(
                    makeLoadRequest({
                        action: 'loadTeachers',
                        teachersSheetUrl: teachersSheetUrl
                    }, 'teachers')
                );
            }

            // Load subjects if URL provided
            if (subjectsSheetUrl) {
                loadPromises.push(
                    makeLoadRequest({
                        action: 'loadSubjects',
                        subjectsSheetUrl: subjectsSheetUrl
                    }, 'subjects')
                );
            }

            // Load classes if URL provided
            if (classesSheetUrl) {
                loadPromises.push(
                    makeLoadRequest({
                        action: 'loadClasses',
                        classesSheetUrl: classesSheetUrl
                    }, 'classes')
                );
            }

            // Load time slots if URL provided
            if (timeSlotsSheetUrl) {
                loadPromises.push(
                    makeLoadRequest({
                        action: 'loadTimeSlots',
                        timeSlotsSheetUrl: timeSlotsSheetUrl
                    }, 'timeSlots')
                );
            }

            if (loadPromises.length === 0) {
                return Promise.resolve(0); // No URLs configured
            }

            showNotification('Memuat data dari Google Sheets...', 'info');

            return Promise.all(loadPromises)
                .then(results => {
                    let loadedCount = 0;

                    results.forEach(result => {
                        if (result.data.success) {
                            switch (result.type) {
                                case 'students':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        studentsData = result.data.data;
                                        localStorage.setItem('studentsData', JSON.stringify(studentsData));
                                        loadedCount++;
                                    }
                                    break;
                                case 'teachers':
                                    if (result.data.data && Object.keys(result.data.data).length > 0) {
                                        Object.assign(users, result.data.data);
                                        loadedCount++;
                                    }
                                    break;
                                case 'subjects':
                                    if (result.data.data && result.data.data.length > 0) {
                                        subjectConfig = result.data.data;
                                        localStorage.setItem('subjectConfig', JSON.stringify(subjectConfig));
                                        loadedCount++;
                                    }
                                    break;
                                case 'classes':
                                    if (result.data.data && result.data.data.length > 0) {
                                        classConfig = result.data.data;
                                        localStorage.setItem('classConfig', JSON.stringify(classConfig));
                                        loadedCount++;
                                    }
                                    break;
                                case 'timeSlots':
                                    if (result.data.data && result.data.data.length > 0) {
                                        timeSlotConfig = result.data.data;
                                        localStorage.setItem('timeSlotConfig', JSON.stringify(timeSlotConfig));
                                        loadedCount++;
                                    }
                                    break;
                            }
                        } else {
                            console.warn(`Failed to load ${result.type}:`, result.data.message);
                        }
                    });

                    // Refresh dropdowns after loading data
                    populateDropdowns();

                    if (loadedCount > 0) {
                        showNotification(`Data berhasil dimuat dari ${loadedCount} sheet!`, 'success');
                    } else {
                        showNotification('Tidak ada data yang dimuat dari sheets (mungkin sheets kosong)', 'info');
                    }

                    return loadedCount;
                })
                .catch(error => {
                    console.error('Error loading data from sheets:', error);
                    showNotification(`Gagal memuat data dari sheets: ${error.message}`, 'error');
                    throw error;
                });
        }

        // Test Apps Script connection
        function testAppsScriptConnection() {
            const deploymentId = document.getElementById('deploymentId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();

            if (!deploymentId && !webAppUrl) {
                showNotification('Masukkan Deployment ID atau Web App URL!', 'error');
                return;
            }

            // Use provided URL or construct from deployment ID
            let testUrl = webAppUrl;
            if (!testUrl && deploymentId) {
                testUrl = `https://script.google.com/macros/s/${deploymentId}/exec`;
            }

            // Validate URL format
            if (!testUrl.startsWith('https://script.google.com/macros/s/')) {
                showConnectionStatus('‚ùå Format URL tidak valid! Harus dimulai dengan https://script.google.com/macros/s/', 'error');
                return;
            }

            showConnectionStatus('üîÑ Testing koneksi ke Google Apps Script...', 'info');

            const payload = {
                action: 'test',
                timestamp: new Date().toISOString()
            };

            // Enhanced test with multiple methods
            const testMultipleMethods = async () => {
                let lastError = null;

                // Method 1: POST with no-cors (most reliable for Apps Script)
                try {
                    showConnectionStatus('üîÑ Testing dengan POST (no-cors)...', 'info');
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const response = await fetch(testUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        mode: 'no-cors',
                        credentials: 'omit',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('üìä POST no-cors response:', response);

                    // For no-cors mode, we can't read the response, but if no error thrown, assume success
                    if (response.type === 'opaque') {
                        showConnectionStatus('‚úÖ Koneksi berhasil! Apps Script merespons dengan baik (no-cors mode).', 'success');
                        showNotification('Koneksi berhasil!', 'success');

                        // Auto-fill web app URL if only deployment ID was provided
                        if (!webAppUrl && deploymentId) {
                            document.getElementById('webAppUrl').value = testUrl;
                        }
                        return;
                    }

                } catch (noCorsError) {
                    console.error('‚ùå POST no-cors failed:', noCorsError);
                    lastError = noCorsError;

                    // Method 2: POST with CORS
                    try {
                        showConnectionStatus('üîÑ Testing dengan POST (CORS)...', 'info');
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);

                        const response = await fetch(testUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json, text/plain, */*'
                            },
                            body: JSON.stringify(payload),
                            mode: 'cors',
                            credentials: 'omit',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        console.log('üìä POST CORS response status:', response.status);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const text = await response.text();
                        console.log('üìÑ POST CORS response text:', text);

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil') || text.includes('OK')) {
                                data = { success: true, message: 'Koneksi berhasil (response non-JSON)' };
                            } else {
                                throw new Error('Response tidak valid dari POST CORS');
                            }
                        }

                        if (data.success) {
                            showConnectionStatus(`‚úÖ Koneksi berhasil dengan POST CORS! ${data.message || 'Apps Script merespons dengan baik.'}`, 'success');
                            showNotification('Koneksi berhasil!', 'success');

                            // Auto-fill web app URL if only deployment ID was provided
                            if (!webAppUrl && deploymentId) {
                                document.getElementById('webAppUrl').value = testUrl;
                            }
                            return;
                        } else {
                            throw new Error(data.message || 'POST CORS gagal');
                        }

                    } catch (corsError) {
                        console.error('‚ùå POST CORS failed:', corsError);
                        lastError = corsError;

                        // Method 3: GET method
                        try {
                            showConnectionStatus('üîÑ Testing dengan GET...', 'info');
                            const params = new URLSearchParams({
                                action: 'test',
                                timestamp: new Date().toISOString()
                            });

                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 15000);

                            const response = await fetch(`${testUrl}?${params}`, {
                                method: 'GET',
                                mode: 'cors',
                                credentials: 'omit',
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);
                            console.log('üìä GET response status:', response.status);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const text = await response.text();
                            console.log('üìÑ GET response text:', text);

                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil') || text.includes('OK')) {
                                    data = { success: true, message: 'Koneksi berhasil (response non-JSON)' };
                                } else {
                                    throw new Error('Response tidak valid dari GET');
                                }
                            }

                            if (data.success) {
                                showConnectionStatus(`‚úÖ Koneksi berhasil dengan GET! ${data.message || 'Apps Script merespons dengan baik.'}`, 'success');
                                showNotification('Koneksi berhasil!', 'success');

                                // Auto-fill web app URL if only deployment ID was provided
                                if (!webAppUrl && deploymentId) {
                                    document.getElementById('webAppUrl').value = testUrl;
                                }
                                return;
                            } else {
                                throw new Error(data.message || 'GET gagal');
                            }

                        } catch (getError) {
                            console.error('‚ùå GET method failed:', getError);
                            lastError = getError;

                            // Method 4: Simple GET without parameters (basic connectivity test)
                            try {
                                showConnectionStatus('üîÑ Testing konektivitas dasar...', 'info');
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 10000);

                                const response = await fetch(testUrl, {
                                    method: 'GET',
                                    mode: 'no-cors',
                                    credentials: 'omit',
                                    signal: controller.signal
                                });

                                clearTimeout(timeoutId);
                                console.log('üìä Basic connectivity response:', response);

                                // If we get here without error, the URL is reachable
                                if (response.type === 'opaque') {
                                    showConnectionStatus('‚úÖ URL dapat diakses! Apps Script kemungkinan berfungsi. Coba deploy ulang jika masih ada masalah.', 'success');
                                    showNotification('URL dapat diakses! Coba deploy ulang Apps Script jika masih ada masalah.', 'info');

                                    // Auto-fill web app URL if only deployment ID was provided
                                    if (!webAppUrl && deploymentId) {
                                        document.getElementById('webAppUrl').value = testUrl;
                                    }
                                    return;
                                }

                            } catch (basicError) {
                                console.error('‚ùå Basic connectivity failed:', basicError);
                                lastError = basicError;

                                // Final error message
                                showConnectionStatus('‚ùå Semua metode koneksi gagal. Periksa konfigurasi Apps Script!', 'error');
                                showNotification('Koneksi gagal! Periksa panduan setup di bawah.', 'error');

                                // Show detailed error information
                                console.error('Detailed error information:');
                                console.error('- URL:', testUrl);
                                console.error('- Last error:', lastError);
                                console.error('- Possible causes:');
                                console.error('  1. Apps Script belum di-deploy sebagai web app');
                                console.error('  2. Permission tidak diatur dengan benar');
                                console.error('  3. URL deployment salah');
                                console.error('  4. Apps Script code error');
                            }
                        }
                    }
                }
            };

            testMultipleMethods();
        }

        // Show connection status
        function showConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            const messageP = document.getElementById('connectionMessage');

            statusDiv.className = `p-4 rounded-lg ${type === 'success' ? 'bg-green-50 border border-green-200' :
                type === 'error' ? 'bg-red-50 border border-red-200' :
                    'bg-blue-50 border border-blue-200'}`;

            messageP.className = `text-sm font-medium ${type === 'success' ? 'text-green-800' :
                type === 'error' ? 'text-red-800' :
                    'text-blue-800'}`;

            messageP.textContent = message;
            statusDiv.classList.remove('hidden');

            // Auto hide after 10 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 10000);
            }
        }



        // Student management variables
        let currentEditingStudent = null;
        let studentToDelete = null;

        // Teacher management variables
        let currentEditingTeacher = null;
        let teacherToDelete = null;

        // Load students data and populate table
        function loadStudentsData() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            let allStudents = [];

            // Collect all students from all classes
            Object.entries(studentsData).forEach(([className, students]) => {
                students.forEach(student => {
                    allStudents.push({
                        ...student,
                        className: className
                    });
                });
            });

            // Sort by class then by name
            allStudents.sort((a, b) => {
                if (a.className !== b.className) {
                    return a.className.localeCompare(b.className);
                }
                return a.name.localeCompare(b.name);
            });

            if (allStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Belum ada data siswa</td></tr>';
                return;
            }

            allStudents.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.className}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">${student.qr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editStudent('${student.className}', '${student.id}')" 
                                    class="text-blue-600 hover:text-blue-900 text-sm">
                                Edit
                            </button>
                            <button onclick="showDeleteModal('${student.className}', '${student.id}')" 
                                    class="text-red-600 hover:text-red-900 text-sm">
                                Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update filter dropdown
            updateStudentFilterDropdown();
        }

        // Update student filter dropdown
        function updateStudentFilterDropdown() {
            const filterSelect = document.getElementById('studentFilterClass');
            const currentValue = filterSelect.value;

            // Clear existing options except first one
            while (filterSelect.children.length > 1) {
                filterSelect.removeChild(filterSelect.lastChild);
            }

            // Add classes that have students
            Object.keys(studentsData).forEach(className => {
                if (studentsData[className].length > 0) {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    filterSelect.appendChild(option);
                }
            });

            // Restore previous value if it still exists
            if (currentValue && Object.keys(studentsData).includes(currentValue)) {
                filterSelect.value = currentValue;
            }
        }

        // Filter students based on class and search term
        function filterStudents() {
            const filterClass = document.getElementById('studentFilterClass').value;
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const tbody = document.getElementById('studentsTableBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 5) return; // Skip empty state row

                const studentId = cells[0].textContent.toLowerCase();
                const studentName = cells[1].textContent.toLowerCase();
                const studentClass = cells[2].textContent;

                const matchesClass = !filterClass || studentClass === filterClass;
                const matchesSearch = !searchTerm ||
                    studentName.includes(searchTerm) ||
                    studentId.includes(searchTerm);

                if (matchesClass && matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Show add student modal
        function showAddStudentModal() {
            currentEditingStudent = null;
            document.getElementById('studentModalTitle').textContent = 'Tambah Siswa Baru';
            document.getElementById('studentForm').reset();

            // Populate class dropdown
            const classSelect = document.getElementById('studentClass');
            classSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            classConfig.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });

            document.getElementById('studentModal').classList.remove('hidden');
        }

        // Edit student
        function editStudent(className, studentId) {
            const student = studentsData[className].find(s => s.id === studentId);
            if (!student) return;

            currentEditingStudent = { className, studentId };
            document.getElementById('studentModalTitle').textContent = 'Edit Data Siswa';

            // Populate form
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentQR').value = student.qr;

            // Populate class dropdown
            const classSelect = document.getElementById('studentClass');
            classSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            classConfig.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                if (cls === className) option.selected = true;
                classSelect.appendChild(option);
            });

            document.getElementById('studentModal').classList.remove('hidden');
        }

        // Save student (add or edit)
        function saveStudent(event) {
            event.preventDefault();

            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            let studentQR = document.getElementById('studentQR').value.trim();

            if (!studentId || !studentName || !studentClass) {
                showNotification('Lengkapi semua field yang wajib diisi!', 'error');
                return;
            }

            // Generate QR code if empty
            if (!studentQR) {
                studentQR = 'STD' + studentId;
            }

            // Check for duplicate ID (except when editing the same student)
            let isDuplicate = false;
            Object.entries(studentsData).forEach(([className, students]) => {
                students.forEach(student => {
                    if (student.id === studentId) {
                        // Allow if editing the same student
                        if (!currentEditingStudent ||
                            currentEditingStudent.className !== className ||
                            currentEditingStudent.studentId !== studentId) {
                            isDuplicate = true;
                        }
                    }
                });
            });

            if (isDuplicate) {
                showNotification('NIS sudah digunakan!', 'error');
                return;
            }

            // Check for duplicate QR code
            let isDuplicateQR = false;
            Object.entries(studentsData).forEach(([className, students]) => {
                students.forEach(student => {
                    if (student.qr === studentQR) {
                        // Allow if editing the same student
                        if (!currentEditingStudent ||
                            currentEditingStudent.className !== className ||
                            currentEditingStudent.studentId !== student.id) {
                            isDuplicateQR = true;
                        }
                    }
                });
            });

            if (isDuplicateQR) {
                showNotification('QR Code sudah digunakan!', 'error');
                return;
            }

            const newStudent = {
                id: studentId,
                name: studentName,
                qr: studentQR
            };

            if (currentEditingStudent) {
                // Edit existing student
                const oldClassName = currentEditingStudent.className;
                const oldStudentId = currentEditingStudent.studentId;

                // Remove from old class
                studentsData[oldClassName] = studentsData[oldClassName].filter(s => s.id !== oldStudentId);

                // Add to new class
                if (!studentsData[studentClass]) {
                    studentsData[studentClass] = [];
                }
                studentsData[studentClass].push(newStudent);

                showNotification('Data siswa berhasil diperbarui!', 'success');
            } else {
                // Add new student
                if (!studentsData[studentClass]) {
                    studentsData[studentClass] = [];
                }
                studentsData[studentClass].push(newStudent);

                showNotification('Siswa baru berhasil ditambahkan!', 'success');
            }

            // Save to localStorage
            localStorage.setItem('studentsData', JSON.stringify(studentsData));

            // Auto sync to Google Sheets if configured
            if (localStorage.getItem('deploymentId') || localStorage.getItem('webAppUrl')) {
                syncStudentsToSheets().catch(error => {
                    console.error('Auto sync students failed:', error);
                    // Don't show error notification for auto sync failure
                });
            }

            // Refresh displays
            loadStudentsData();
            loadStudentsQR();

            // Close modal
            closeStudentModal();
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('studentModal').classList.add('hidden');
            currentEditingStudent = null;
        }

        // Show delete confirmation modal
        function showDeleteModal(className, studentId) {
            studentToDelete = { className, studentId };
            document.getElementById('deleteModalMessage').textContent = 'Yakin ingin menghapus data siswa ini? Tindakan ini tidak dapat dibatalkan.';
            document.getElementById('confirmDeleteBtn').onclick = confirmDeleteStudent;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            studentToDelete = null;
            teacherToDelete = null;
        }

        // Confirm delete student
        function confirmDeleteStudent() {
            if (!studentToDelete) return;

            const { className, studentId } = studentToDelete;

            // Remove student from data
            studentsData[className] = studentsData[className].filter(s => s.id !== studentId);

            // Remove empty class arrays
            if (studentsData[className].length === 0) {
                delete studentsData[className];
            }

            // Save to localStorage
            localStorage.setItem('studentsData', JSON.stringify(studentsData));

            // Auto sync to Google Sheets if configured
            if (localStorage.getItem('deploymentId') || localStorage.getItem('webAppUrl')) {
                syncStudentsToSheets().catch(error => {
                    console.error('Auto sync students failed:', error);
                    // Don't show error notification for auto sync failure
                });
            }

            // Refresh displays
            loadStudentsData();
            loadStudentsQR();

            // Close modal
            closeDeleteModal();

            showNotification('Data siswa berhasil dihapus!', 'success');
        }

        // Load students QR codes (QR code SVG/canvas + download button)
        function loadStudentsQR() {
            const container = document.getElementById('studentsQRContainer');
            container.innerHTML = '';

            let hasStudents = false;

            Object.entries(studentsData).forEach(([className, students]) => {
                students.forEach(student => {
                    hasStudents = true;
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-gray-200 rounded-lg p-4 text-center';

                    // Tempat QR code akan di-generate
                    const qrId = `qr-${student.id}`;
                    div.innerHTML = `
                    <div class="mb-4">
                        <div id="${qrId}" class="mx-auto flex justify-center items-center" style="text-align:center;"></div>
                    </div>
                    <h3 class="font-semibold text-gray-800">${student.name}</h3>
                    <p class="text-sm text-gray-600">ID: ${student.id}</p>
                    <p class="text-sm text-gray-600">Kelas: ${className}</p>
                    <button onclick="downloadQRCode('${qrId}', '${student.name}')"
                            class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        Download QR
                    </button>
                `;
                    container.appendChild(div);

                    // Generate QR code
                    setTimeout(() => {
                        const qrContainer = document.getElementById(qrId);
                        qrContainer.innerHTML = '';
                        new QRCode(qrContainer, {
                            text: student.qr,
                            width: 128,
                            height: 128,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }, 0);
                });
            });

            if (!hasStudents) {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Belum ada data siswa untuk ditampilkan</div>';
            }
        }

        // Download QR code as image
        function downloadQRCode(qrId, studentName) {
            const qrDiv = document.getElementById(qrId);
            // Cari <img> di dalam qrDiv (qrcodejs default output)
            const img = qrDiv.querySelector('img');
            if (img) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `QR-${studentName.replace(/\s+/g, '_')}.png`;
                link.click();
            } else {
                showNotification('Gagal download QR. Coba reload halaman.', 'error');
            }
        }


        // Default configuration values
        const defaultConfig = {
            deploymentId: 'AKfycbzZKzMm-BPA3DS9PK-hpH7orcPRFiNdyj5Fj8K6jWtyTOOiv0KMQTOXPiNyD6F-S6bOig',
            webAppUrl: 'https://script.google.com/macros/s/AKfycbzZKzMm-BPA3DS9PK-hpH7orcPRFiNdyj5Fj8K6jWtyTOOiv0KMQTOXPiNyD6F-S6bOig/exec',
            attendanceSheetUrl: 'https://docs.google.com/spreadsheets/d/1I-HamlApJnN94hb0krBp1Kk-940GpoYyJxeuBj5mFr4/edit?gid=0#gid=0',
            studentsSheetUrl: 'https://docs.google.com/spreadsheets/d/1I-HamlApJnN94hb0krBp1Kk-940GpoYyJxeuBj5mFr4/edit?gid=174381718#gid=174381718',
            teachersSheetUrl: 'https://docs.google.com/spreadsheets/d/1I-HamlApJnN94hb0krBp1Kk-940GpoYyJxeuBj5mFr4/edit?gid=268200759#gid=268200759',
            subjectsSheetUrl: 'https://docs.google.com/spreadsheets/d/1I-HamlApJnN94hb0krBp1Kk-940GpoYyJxeuBj5mFr4/edit?gid=1293757566#gid=1293757566',
            classesSheetUrl: 'https://docs.google.com/spreadsheets/d/1I-HamlApJnN94hb0krBp1Kk-940GpoYyJxeuBj5mFr4/edit?gid=846564730#gid=846564730'
        };

        // Initialize default configuration if not exists
        function initializeDefaultConfiguration() {
            // Set default configuration if not already set
            if (!localStorage.getItem('deploymentId')) {
                localStorage.setItem('deploymentId', defaultConfig.deploymentId);
            }
            if (!localStorage.getItem('webAppUrl')) {
                localStorage.setItem('webAppUrl', defaultConfig.webAppUrl);
            }
            if (!localStorage.getItem('attendanceSheetUrl')) {
                localStorage.setItem('attendanceSheetUrl', defaultConfig.attendanceSheetUrl);
            }
            if (!localStorage.getItem('studentsSheetUrl')) {
                localStorage.setItem('studentsSheetUrl', defaultConfig.studentsSheetUrl);
            }
            if (!localStorage.getItem('teachersSheetUrl')) {
                localStorage.setItem('teachersSheetUrl', defaultConfig.teachersSheetUrl);
            }
            if (!localStorage.getItem('subjectsSheetUrl')) {
                localStorage.setItem('subjectsSheetUrl', defaultConfig.subjectsSheetUrl);
            }
            if (!localStorage.getItem('classesSheetUrl')) {
                localStorage.setItem('classesSheetUrl', defaultConfig.classesSheetUrl);
            }

            console.log('‚úÖ Konfigurasi default telah diinisialisasi');
        }

        // Settings functions
        function loadSettings() {
            document.getElementById('deploymentId').value = localStorage.getItem('deploymentId') || defaultConfig.deploymentId;
            document.getElementById('webAppUrl').value = localStorage.getItem('webAppUrl') || defaultConfig.webAppUrl;
            document.getElementById('attendanceSheetUrl').value = localStorage.getItem('attendanceSheetUrl') || defaultConfig.attendanceSheetUrl;
            document.getElementById('studentsSheetUrl').value = localStorage.getItem('studentsSheetUrl') || defaultConfig.studentsSheetUrl;
            document.getElementById('teachersSheetUrl').value = localStorage.getItem('teachersSheetUrl') || defaultConfig.teachersSheetUrl;
            document.getElementById('subjectsSheetUrl').value = localStorage.getItem('subjectsSheetUrl') || defaultConfig.subjectsSheetUrl;
            document.getElementById('classesSheetUrl').value = localStorage.getItem('classesSheetUrl') || defaultConfig.classesSheetUrl;


            // Load configuration lists
            loadClassList();
            loadSubjectList();
            loadTimeSlotList();
            loadTeachersData();
        }

        function saveSettings() {
            const deploymentId = document.getElementById('deploymentId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const attendanceSheetUrl = document.getElementById('attendanceSheetUrl').value.trim();
            const studentsSheetUrl = document.getElementById('studentsSheetUrl').value.trim();
            const teachersSheetUrl = document.getElementById('teachersSheetUrl').value.trim();
            const subjectsSheetUrl = document.getElementById('subjectsSheetUrl').value.trim();
            const classesSheetUrl = document.getElementById('classesSheetUrl').value.trim();


            // Save all settings
            localStorage.setItem('deploymentId', deploymentId);
            localStorage.setItem('webAppUrl', webAppUrl);
            localStorage.setItem('attendanceSheetUrl', attendanceSheetUrl);
            localStorage.setItem('studentsSheetUrl', studentsSheetUrl);
            localStorage.setItem('teachersSheetUrl', teachersSheetUrl);
            localStorage.setItem('subjectsSheetUrl', subjectsSheetUrl);
            localStorage.setItem('classesSheetUrl', classesSheetUrl);


            showNotification('Pengaturan berhasil disimpan!', 'success');
        }

        // Class configuration functions
        function loadClassList() {
            const container = document.getElementById('classListContainer');
            container.innerHTML = '';

            classConfig.forEach((className, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${className}</span>
                    <button onclick="removeClass(${index})" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Hapus
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function addClass() {
            const newClassName = document.getElementById('newClassName').value.trim();

            if (!newClassName) {
                showNotification('Masukkan nama kelas!', 'error');
                return;
            }

            if (classConfig.includes(newClassName)) {
                showNotification('Kelas sudah ada!', 'error');
                return;
            }

            classConfig.push(newClassName);
            localStorage.setItem('classConfig', JSON.stringify(classConfig));

            // Auto sync to Google Sheets if configured
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const classesSheetUrl = localStorage.getItem('classesSheetUrl');

            if (webAppUrl && classesSheetUrl) {
                showNotification('Menyimpan kelas ke Google Sheets...', 'info');

                const payload = {
                    action: 'syncClasses',
                    classesSheetUrl: classesSheetUrl,
                    classesData: classConfig
                };

                // Try POST first, then GET as fallback
                fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors',
                    credentials: 'omit'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, message: 'Kelas berhasil disimpan ke Google Sheets!' };
                            } else {
                                throw new Error('Response tidak valid');
                            }
                        }

                        if (data.success) {
                            showNotification(`Kelas "${newClassName}" berhasil ditambahkan dan disimpan ke Google Sheets!`, 'success');
                        } else {
                            showNotification(`Kelas ditambahkan tapi gagal disimpan ke Google Sheets: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('POST failed, trying GET:', error);

                        // Fallback to GET method
                        const params = new URLSearchParams({
                            action: 'syncClasses',
                            data: JSON.stringify({
                                classesSheetUrl: classesSheetUrl,
                                classesData: classConfig
                            })
                        });

                        fetch(`${webAppUrl}?${params}`, {
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.text();
                            })
                            .then(text => {
                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch {
                                    if (text.includes('success') || text.includes('berhasil')) {
                                        data = { success: true, message: 'Kelas berhasil disimpan ke Google Sheets!' };
                                    } else {
                                        throw new Error('Response tidak valid');
                                    }
                                }

                                if (data.success) {
                                    showNotification(`Kelas "${newClassName}" berhasil ditambahkan dan disimpan ke Google Sheets!`, 'success');
                                } else {
                                    showNotification(`Kelas ditambahkan tapi gagal disimpan ke Google Sheets: ${data.message}`, 'error');
                                }
                            })
                            .catch(getError => {
                                console.error('Both POST and GET failed:', getError);
                                showNotification(`Kelas "${newClassName}" berhasil ditambahkan tapi gagal disimpan ke Google Sheets!`, 'error');
                            });
                    });
            } else {
                showNotification(`Kelas "${newClassName}" berhasil ditambahkan!`, 'success');
            }

            document.getElementById('newClassName').value = '';
            loadClassList();
            populateDropdowns();
        }

        function removeClass(index) {
            const className = classConfig[index];

            // Check if class has students
            if (studentsData[className] && studentsData[className].length > 0) {
                if (!confirm(`Kelas ${className} memiliki data siswa. Yakin ingin menghapus?`)) {
                    return;
                }
                // Remove students data for this class
                delete studentsData[className];
                localStorage.setItem('studentsData', JSON.stringify(studentsData));
            }

            classConfig.splice(index, 1);
            localStorage.setItem('classConfig', JSON.stringify(classConfig));

            loadClassList();
            populateDropdowns();

            showNotification('Kelas berhasil dihapus!', 'success');
        }

        // Subject configuration functions
        function loadSubjectList() {
            const container = document.getElementById('subjectListContainer');
            container.innerHTML = '';

            subjectConfig.forEach((subject, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${subject}</span>
                    <button onclick="removeSubject(${index})" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Hapus
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function addSubject() {
            const newSubject = document.getElementById('newSubjectName').value.trim();

            if (!newSubject) {
                showNotification('Masukkan nama mata pelajaran!', 'error');
                return;
            }

            if (subjectConfig.includes(newSubject)) {
                showNotification('Mata pelajaran sudah ada!', 'error');
                return;
            }

            subjectConfig.push(newSubject);
            localStorage.setItem('subjectConfig', JSON.stringify(subjectConfig));

            // Auto sync to Google Sheets if configured
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const subjectsSheetUrl = localStorage.getItem('subjectsSheetUrl');

            if (webAppUrl && subjectsSheetUrl) {
                showNotification('Menyimpan mata pelajaran ke Google Sheets...', 'info');

                const payload = {
                    action: 'syncSubjects',
                    subjectsSheetUrl: subjectsSheetUrl,
                    subjectsData: subjectConfig
                };

                // Try POST first, then GET as fallback
                fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors',
                    credentials: 'omit'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, message: 'Mata pelajaran berhasil disimpan ke Google Sheets!' };
                            } else {
                                throw new Error('Response tidak valid');
                            }
                        }

                        if (data.success) {
                            showNotification(`Mata pelajaran "${newSubject}" berhasil ditambahkan dan disimpan ke Google Sheets!`, 'success');
                        } else {
                            showNotification(`Mata pelajaran ditambahkan tapi gagal disimpan ke Google Sheets: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('POST failed, trying GET:', error);

                        // Fallback to GET method
                        const params = new URLSearchParams({
                            action: 'syncSubjects',
                            data: JSON.stringify({
                                subjectsSheetUrl: subjectsSheetUrl,
                                subjectsData: subjectConfig
                            })
                        });

                        fetch(`${webAppUrl}?${params}`, {
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.text();
                            })
                            .then(text => {
                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch {
                                    if (text.includes('success') || text.includes('berhasil')) {
                                        data = { success: true, message: 'Mata pelajaran berhasil disimpan ke Google Sheets!' };
                                    } else {
                                        throw new Error('Response tidak valid');
                                    }
                                }

                                if (data.success) {
                                    showNotification(`Mata pelajaran "${newSubject}" berhasil ditambahkan dan disimpan ke Google Sheets!`, 'success');
                                } else {
                                    showNotification(`Mata pelajaran ditambahkan tapi gagal disimpan ke Google Sheets: ${data.message}`, 'error');
                                }
                            })
                            .catch(getError => {
                                console.error('Both POST and GET failed:', getError);
                                showNotification(`Mata pelajaran "${newSubject}" berhasil ditambahkan tapi gagal disimpan ke Google Sheets!`, 'error');
                            });
                    });
            } else {
                showNotification(`Mata pelajaran "${newSubject}" berhasil ditambahkan!`, 'success');
            }

            document.getElementById('newSubjectName').value = '';
            loadSubjectList();
            populateDropdowns();
        }

        function removeSubject(index) {
            subjectConfig.splice(index, 1);
            localStorage.setItem('subjectConfig', JSON.stringify(subjectConfig));

            loadSubjectList();
            populateDropdowns();

            showNotification('Mata pelajaran berhasil dihapus!', 'success');
        }

        // Time slot configuration functions
        function loadTimeSlotList() {
            const container = document.getElementById('timeSlotListContainer');
            container.innerHTML = '';

            timeSlotConfig.forEach((timeSlot, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${timeSlot}</span>
                    <button onclick="removeTimeSlot(${index})" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Hapus
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function addTimeSlot() {
            const startTime = document.getElementById('newTimeStart').value;
            const endTime = document.getElementById('newTimeEnd').value;

            if (!startTime || !endTime) {
                showNotification('Masukkan jam mulai dan jam selesai!', 'error');
                return;
            }

            if (startTime >= endTime) {
                showNotification('Jam mulai harus lebih awal dari jam selesai!', 'error');
                return;
            }

            const newTimeSlot = `${startTime}-${endTime}`;

            if (timeSlotConfig.includes(newTimeSlot)) {
                showNotification('Jam pelajaran sudah ada!', 'error');
                return;
            }

            // Add new time slot to local config
            timeSlotConfig.push(newTimeSlot);
            // Sort time slots
            timeSlotConfig.sort();
            localStorage.setItem('timeSlotConfig', JSON.stringify(timeSlotConfig));

            // Clear form and update display immediately
            document.getElementById('newTimeStart').value = '';
            document.getElementById('newTimeEnd').value = '';
            loadTimeSlotList();
            populateDropdowns();

            // Show success message immediately for local save
            showNotification(`Jam pelajaran "${newTimeSlot}" berhasil ditambahkan!`, 'success');

            // Auto sync to Google Sheets if configured (background process)
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            if (webAppUrl && timeSlotsSheetUrl) {
                console.log('üîÑ Menyimpan semua jam pelajaran ke Google Sheets...');
                console.log('üìã Data yang akan disimpan:', timeSlotConfig);
                console.log('üåê Web App URL:', webAppUrl);
                console.log('üìä Sheet URL:', timeSlotsSheetUrl);

                // Use the enhanced sync method with multiple fallbacks
                const tryMultipleMethods = async () => {
                    const payload = {
                        action: 'syncTimeSlots',
                        timeSlotsSheetUrl: timeSlotsSheetUrl,
                        timeSlotsData: timeSlotConfig
                    };

                    // Method 1: POST with JSON
                    try {
                        console.log('üîÑ Mencoba POST dengan JSON...');
                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        console.log('üìä POST response status:', response.status);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const text = await response.text();
                        console.log('üìÑ POST response text:', text);

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, message: `Jam pelajaran berhasil disimpan ke Google Sheets! (${timeSlotConfig.length} jam)` };
                            } else {
                                throw new Error('Response tidak valid dari POST');
                            }
                        }

                        if (data.success) {
                            console.log('‚úÖ POST sync berhasil:', data.message);
                            showNotification(`‚úÖ Sync berhasil! Total ${timeSlotConfig.length} jam pelajaran tersimpan di Google Sheets.`, 'success');
                            return Promise.resolve(data);
                        } else {
                            throw new Error(data.message || 'POST gagal');
                        }
                    } catch (postError) {
                        console.error('‚ùå POST method failed:', postError);

                        // Method 2: POST with form data
                        try {
                            console.log('üîÑ Mencoba POST dengan form data...');
                            const formData = new FormData();
                            formData.append('payload', JSON.stringify(payload));

                            const response = await fetch(webAppUrl, {
                                method: 'POST',
                                body: formData,
                                mode: 'cors',
                                credentials: 'omit'
                            });

                            console.log('üìä POST form response status:', response.status);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const text = await response.text();
                            console.log('üìÑ POST form response text:', text);

                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, message: `Jam pelajaran berhasil disimpan ke Google Sheets! (${timeSlotConfig.length} jam)` };
                                } else {
                                    throw new Error('Response tidak valid dari POST form');
                                }
                            }

                            if (data.success) {
                                console.log('‚úÖ POST form sync berhasil:', data.message);
                                showNotification(`‚úÖ Sync berhasil! Total ${timeSlotConfig.length} jam pelajaran tersimpan di Google Sheets.`, 'success');
                                return Promise.resolve(data);
                            } else {
                                throw new Error(data.message || 'POST form gagal');
                            }
                        } catch (formError) {
                            console.error('‚ùå POST form method failed:', formError);

                            // Method 3: GET with parameters
                            try {
                                console.log('üîÑ Mencoba GET dengan parameters...');
                                const params = new URLSearchParams({
                                    action: 'syncTimeSlots',
                                    timeSlotsSheetUrl: timeSlotsSheetUrl,
                                    data: JSON.stringify({
                                        timeSlotsData: timeSlotConfig
                                    })
                                });

                                const getUrl = `${webAppUrl}?${params}`;
                                console.log('üîó GET URL:', getUrl);

                                const response = await fetch(getUrl, {
                                    method: 'GET',
                                    mode: 'cors',
                                    credentials: 'omit'
                                });

                                console.log('üìä GET response status:', response.status);

                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }

                                const text = await response.text();
                                console.log('üìÑ GET response text:', text);

                                let data;
                                try {
                                    data = JSON.parse(text);
                                } catch {
                                    if (text.includes('success') || text.includes('berhasil')) {
                                        data = { success: true, message: `Jam pelajaran berhasil disimpan ke Google Sheets! (${timeSlotConfig.length} jam)` };
                                    } else {
                                        throw new Error('Response tidak valid dari GET');
                                    }
                                }

                                if (data.success) {
                                    console.log('‚úÖ GET sync berhasil:', data.message);
                                    showNotification(`‚úÖ Sync berhasil! Total ${timeSlotConfig.length} jam pelajaran tersimpan di Google Sheets.`, 'success');
                                    return Promise.resolve(data);
                                } else {
                                    throw new Error(data.message || 'GET gagal');
                                }
                            } catch (getError) {
                                console.error('‚ùå Semua metode gagal:', getError);

                                // Method 4: Silent iframe method (no error notification)
                                console.log('üîÑ Mencoba metode iframe sebagai fallback terakhir...');

                                try {
                                    // Create hidden iframe
                                    const iframe = document.createElement('iframe');
                                    iframe.style.display = 'none';
                                    iframe.name = 'sync-frame-' + Date.now();
                                    document.body.appendChild(iframe);

                                    // Create form to submit to iframe
                                    const form = document.createElement('form');
                                    form.method = 'POST';
                                    form.action = webAppUrl;
                                    form.target = iframe.name;
                                    form.style.display = 'none';

                                    // Add payload as form data
                                    const input = document.createElement('input');
                                    input.type = 'hidden';
                                    input.name = 'payload';
                                    input.value = JSON.stringify(payload);
                                    form.appendChild(input);

                                    document.body.appendChild(form);

                                    // Handle iframe load with timeout
                                    let completed = false;

                                    const cleanup = () => {
                                        if (!completed) {
                                            completed = true;
                                            try {
                                                if (document.body.contains(iframe)) document.body.removeChild(iframe);
                                                if (document.body.contains(form)) document.body.removeChild(form);
                                            } catch (cleanupError) {
                                                console.error('Cleanup error:', cleanupError);
                                            }
                                        }
                                    };

                                    iframe.onload = () => {
                                        console.log('üìÑ Iframe loaded');
                                        setTimeout(() => {
                                            cleanup();
                                            console.log('‚úÖ Iframe sync completed (silent)');
                                            showNotification(`üì§ Data telah dikirim ke Google Sheets. Periksa sheet untuk memastikan tersimpan.`, 'info');
                                        }, 3000);
                                    };

                                    iframe.onerror = () => {
                                        console.error('‚ùå Iframe error');
                                        cleanup();
                                        showNotification(`‚ö†Ô∏è Sync ke Google Sheets mungkin gagal. Data tersimpan lokal.`, 'error');
                                    };

                                    // Timeout fallback
                                    setTimeout(() => {
                                        if (!completed) {
                                            console.log('‚è∞ Iframe timeout');
                                            cleanup();
                                            showNotification(`‚è∞ Sync timeout. Data tersimpan lokal, coba sync manual jika diperlukan.`, 'error');
                                        }
                                    }, 15000);

                                    // Submit form
                                    form.submit();
                                    console.log('üì§ Form submitted to iframe');

                                } catch (iframeError) {
                                    console.error('‚ùå Iframe method failed:', iframeError);
                                    showNotification(`‚ö†Ô∏è Semua metode sync gagal. Data tersimpan lokal, gunakan sync manual.`, 'error');
                                }

                                return Promise.reject(getError);
                            }
                        }
                    }
                };

                // Execute sync in background (don't block UI)
                tryMultipleMethods().catch(error => {
                    console.error('Background sync failed:', error);
                    // Don't show error notification since user already got success for local save
                });
            } else {
                console.log('‚ÑπÔ∏è Google Sheets tidak dikonfigurasi, hanya menyimpan lokal');
            }
        }

        function removeTimeSlot(index) {
            timeSlotConfig.splice(index, 1);
            localStorage.setItem('timeSlotConfig', JSON.stringify(timeSlotConfig));

            loadTimeSlotList();
            populateDropdowns();

            showNotification('Jam pelajaran berhasil dihapus!', 'success');
        }

        function syncTimeSlotsToSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            if (!webAppUrl) {
                return Promise.reject('No web app URL');
            }

            if (!timeSlotsSheetUrl) {
                return Promise.reject('No time slots sheet URL');
            }

            const payload = {
                action: 'syncTimeSlots',
                timeSlotsSheetUrl: timeSlotsSheetUrl,
                timeSlotsData: timeSlotConfig
            };

            // Try POST first, then GET as fallback
            return fetch(webAppUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, message: 'Jam pelajaran berhasil disinkronkan!' };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    if (data.success) {
                        return Promise.resolve(data);
                    } else {
                        return Promise.reject(data.message);
                    }
                })
                .catch(error => {
                    console.error('POST failed, trying GET:', error);

                    // Fallback to GET method
                    const params = new URLSearchParams({
                        action: 'syncTimeSlots',
                        data: JSON.stringify({
                            timeSlotsSheetUrl: timeSlotsSheetUrl,
                            timeSlotsData: timeSlotConfig
                        })
                    });

                    return fetch(`${webAppUrl}?${params}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, message: 'Jam pelajaran berhasil disinkronkan!' };
                                } else {
                                    throw new Error('Response tidak valid');
                                }
                            }

                            if (data.success) {
                                return Promise.resolve(data);
                            } else {
                                return Promise.reject(data.message);
                            }
                        })
                        .catch(getError => {
                            console.error('Both POST and GET failed:', getError);
                            return Promise.reject(getError);
                        });
                });
        }

        // Manual sync function for the button
        function syncTimeSlotsToSheetsManual() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return;
            }

            if (!timeSlotsSheetUrl) {
                showNotification('URL Sheet Jam Pelajaran belum diatur!', 'error');
                return;
            }

            if (timeSlotConfig.length === 0) {
                showNotification('Belum ada jam pelajaran untuk disinkronkan!', 'error');
                return;
            }

            showNotification('Sedang menyinkronkan jam pelajaran...', 'info');

            // Use direct implementation instead of relying on syncTimeSlotsToSheets function
            const payload = {
                action: 'syncTimeSlots',
                timeSlotsSheetUrl: timeSlotsSheetUrl,
                timeSlotsData: timeSlotConfig
            };

            console.log('Syncing time slots with payload:', payload);

            // Try multiple methods to ensure compatibility
            const trySync = async () => {
                // Method 1: POST with JSON
                try {
                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        credentials: 'omit'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const text = await response.text();
                    console.log('POST response:', text);

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, message: `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)` };
                        } else {
                            throw new Error('Response tidak valid dari POST');
                        }
                    }

                    if (data.success) {
                        showNotification(data.message || `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)`, 'success');
                        return;
                    } else {
                        throw new Error(data.message || 'POST gagal');
                    }
                } catch (postError) {
                    console.error('POST method failed:', postError);

                    // Method 2: POST with form data
                    try {
                        const formData = new FormData();
                        formData.append('payload', JSON.stringify(payload));

                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            body: formData,
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const text = await response.text();
                        console.log('POST form response:', text);

                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch {
                            if (text.includes('success') || text.includes('berhasil')) {
                                data = { success: true, message: `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)` };
                            } else {
                                throw new Error('Response tidak valid dari POST form');
                            }
                        }

                        if (data.success) {
                            showNotification(data.message || `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)`, 'success');
                            return;
                        } else {
                            throw new Error(data.message || 'POST form gagal');
                        }
                    } catch (formError) {
                        console.error('POST form method failed:', formError);

                        // Method 3: GET with parameters
                        try {
                            const params = new URLSearchParams({
                                action: 'syncTimeSlots',
                                timeSlotsSheetUrl: timeSlotsSheetUrl,
                                data: JSON.stringify({
                                    timeSlotsData: timeSlotConfig
                                })
                            });

                            const response = await fetch(`${webAppUrl}?${params}`, {
                                method: 'GET',
                                mode: 'cors',
                                credentials: 'omit'
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const text = await response.text();
                            console.log('GET response:', text);

                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, message: `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)` };
                                } else {
                                    throw new Error('Response tidak valid dari GET');
                                }
                            }

                            if (data.success) {
                                showNotification(data.message || `Jam pelajaran berhasil disinkronkan! (${timeSlotConfig.length} jam)`, 'success');
                                return;
                            } else {
                                throw new Error(data.message || 'GET gagal');
                            }
                        } catch (getError) {
                            console.error('All methods failed:', getError);
                            showNotification(`Gagal menyinkronkan jam pelajaran: ${getError.message || getError}`, 'error');
                        }
                    }
                }
            };

            trySync();
        }

        // Manual load users from sheets (for button click)
        function loadUsersFromSheetsManual() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return;
            }

            if (!teachersSheetUrl) {
                showNotification('URL Sheet Data Guru belum diatur!', 'error');
                return;
            }

            showNotification('Memuat data guru dari Google Sheets...', 'info');

            loadUsersFromSheets().then(() => {
                showNotification(`Data guru berhasil dimuat! Total: ${Object.keys(users).length} akun`, 'success');
                console.log('Available users after load:', users);
            }).catch((error) => {
                console.error('Load users error:', error);
                showNotification(`Gagal memuat data guru: ${error.message}`, 'error');
            });
        }

        // Manual load data from sheets (for button click)
        function loadDataFromSheetsManual() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return;
            }

            const studentsSheetUrl = localStorage.getItem('studentsSheetUrl');
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');
            const subjectsSheetUrl = localStorage.getItem('subjectsSheetUrl');
            const classesSheetUrl = localStorage.getItem('classesSheetUrl');
            const timeSlotsSheetUrl = localStorage.getItem('timeSlotsSheetUrl');

            if (!studentsSheetUrl && !teachersSheetUrl && !subjectsSheetUrl && !classesSheetUrl && !timeSlotsSheetUrl) {
                showNotification('Belum ada URL sheet yang dikonfigurasi!', 'error');
                return;
            }

            loadDataFromSheets().then((loadedCount) => {
                populateDropdowns();

                // Refresh current displays
                if (!document.getElementById('studentsTab').classList.contains('hidden')) {
                    loadStudentsData();
                    loadStudentsQR();
                }

                if (!document.getElementById('settingsTab').classList.contains('hidden')) {
                    loadTeachersData();
                }

                if (loadedCount > 0) {
                    showNotification(`Data berhasil dimuat dari ${loadedCount} sheet!`, 'success');
                } else {
                    showNotification('Tidak ada data yang dimuat (sheets mungkin kosong)', 'info');
                }
            }).catch((error) => {
                console.error('Load error:', error);
                showNotification(`Gagal memuat data: ${error.message}`, 'error');
            });
        }

        // Teacher management functions
        function loadTeachersData() {
            const tbody = document.getElementById('teachersTableBody');
            tbody.innerHTML = '';

            const teachersList = Object.entries(users).map(([username, data]) => ({
                username,
                ...data
            }));

            if (teachersList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Belum ada data guru</td></tr>';
                return;
            }

            teachersList.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${teacher.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}">
                            ${teacher.role === 'admin' ? 'Admin' : 'Guru'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editTeacher('${teacher.username}')" 
                                    class="text-blue-600 hover:text-blue-900 text-sm">
                                Edit
                            </button>
                            <button onclick="showDeleteTeacherModal('${teacher.username}')" 
                                    class="text-red-600 hover:text-red-900 text-sm">
                                Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterTeachers() {
            const filterRole = document.getElementById('teacherFilterRole').value;
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            const tbody = document.getElementById('teachersTableBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 5) return; // Skip empty state row

                const username = cells[0].textContent.toLowerCase();
                const name = cells[1].textContent.toLowerCase();
                const roleSpan = cells[2].querySelector('span');
                const role = roleSpan ? (roleSpan.textContent.trim() === 'Admin' ? 'admin' : 'teacher') : '';

                const matchesRole = !filterRole || role === filterRole;
                const matchesSearch = !searchTerm ||
                    name.includes(searchTerm) ||
                    username.includes(searchTerm);

                if (matchesRole && matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showAddTeacherModal() {
            currentEditingTeacher = null;
            document.getElementById('teacherModalTitle').textContent = 'Tambah Guru Baru';
            document.getElementById('teacherForm').reset();
            const modal = document.getElementById('teacherModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function editTeacher(username) {
            const teacher = users[username];
            if (!teacher) return;

            currentEditingTeacher = username;
            document.getElementById('teacherModalTitle').textContent = 'Edit Data Guru';

            // Populate form
            document.getElementById('teacherUsername').value = username;
            document.getElementById('teacherPassword').value = teacher.password;
            document.getElementById('teacherName').value = teacher.name;
            document.getElementById('teacherRole').value = teacher.role;

            document.getElementById('teacherModal').classList.remove('hidden');
        }

        function saveTeacher(event) {
            event.preventDefault();

            const username = document.getElementById('teacherUsername').value.trim();
            const password = document.getElementById('teacherPassword').value.trim();
            const name = document.getElementById('teacherName').value.trim();
            const role = document.getElementById('teacherRole').value;

            if (!username || !password || !name || !role) {
                showNotification('Lengkapi semua field yang wajib diisi!', 'error');
                return;
            }

            // Check for duplicate username (except when editing the same teacher)
            if (users[username] && (!currentEditingTeacher || currentEditingTeacher !== username)) {
                showNotification('Username sudah digunakan!', 'error');
                return;
            }

            const newTeacher = {
                password: password,
                name: name,
                role: role
            };

            if (currentEditingTeacher && currentEditingTeacher !== username) {
                // Username changed, remove old entry
                delete users[currentEditingTeacher];
            }

            // Add/update teacher
            users[username] = newTeacher;

            // Save to localStorage
            localStorage.setItem('usersData', JSON.stringify(users));

            // Auto sync to Google Sheets if configured
            if (localStorage.getItem('deploymentId') || localStorage.getItem('webAppUrl')) {
                syncTeachersToSheets().catch(error => {
                    console.error('Auto sync teachers failed:', error);
                    // Don't show error notification for auto sync failure
                });
            }

            // Refresh display
            loadTeachersData();

            // Close modal
            closeTeacherModal();

            if (currentEditingTeacher) {
                showNotification('Data guru berhasil diperbarui!', 'success');
            } else {
                showNotification('Guru baru berhasil ditambahkan!', 'success');
            }
            function closeTeacherModal() {
                const modal = document.getElementById('teacherModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                currentEditingTeacher = null;
            }
            currentEditingTeacher = null;
        }

        function showDeleteTeacherModal(username) {
            teacherToDelete = username;
            document.getElementById('deleteModalMessage').textContent = 'Yakin ingin menghapus data guru ini? Tindakan ini tidak dapat dibatalkan.';
            document.getElementById('confirmDeleteBtn').onclick = confirmDeleteTeacher;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function confirmDeleteTeacher() {
            if (!teacherToDelete) return;

            // Prevent deleting the currently logged in user
            if (currentUser && currentUser.username === teacherToDelete) {
                showNotification('Tidak dapat menghapus akun yang sedang login!', 'error');
                closeDeleteModal();
                return;
            }

            // Remove teacher from data
            delete users[teacherToDelete];

            // Save to localStorage
            localStorage.setItem('usersData', JSON.stringify(users));

            // Auto sync to Google Sheets if configured
            if (localStorage.getItem('deploymentId') || localStorage.getItem('webAppUrl')) {
                syncTeachersToSheets().catch(error => {
                    console.error('Auto sync teachers failed:', error);
                    // Don't show error notification for auto sync failure
                });
            }

            // Refresh display
            loadTeachersData();

            // Close modal
            closeDeleteModal();

            showNotification('Data guru berhasil dihapus!', 'success');
        }

        function syncTeachersToSheets() {
            const webAppUrl = localStorage.getItem('webAppUrl') ||
                (localStorage.getItem('deploymentId') ?
                    `https://script.google.com/macros/s/${localStorage.getItem('deploymentId')}/exec` : null);
            const teachersSheetUrl = localStorage.getItem('teachersSheetUrl');

            if (!webAppUrl) {
                showNotification('Konfigurasi Web App URL belum lengkap!', 'error');
                return Promise.reject('No web app URL');
            }

            if (!teachersSheetUrl) {
                showNotification('URL Sheet Data Guru belum diatur!', 'error');
                return Promise.reject('No teachers sheet URL');
            }

            showNotification('Sedang menyinkronkan data guru...', 'info');

            const payload = {
                action: 'syncTeachers',
                teachersSheetUrl: teachersSheetUrl,
                teachersData: users
            };

            // Try POST first, then GET as fallback
            return fetch(webAppUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        if (text.includes('success') || text.includes('berhasil')) {
                            data = { success: true, message: 'Data guru berhasil disinkronkan!' };
                        } else {
                            throw new Error('Response tidak valid');
                        }
                    }

                    if (data.success) {
                        showNotification(data.message || 'Data guru berhasil disinkronkan!', 'success');
                        return Promise.resolve(data);
                    } else {
                        showNotification(`Error: ${data.message}`, 'error');
                        return Promise.reject(data.message);
                    }
                })
                .catch(error => {
                    console.error('POST failed, trying GET:', error);

                    // Fallback to GET method
                    const params = new URLSearchParams({
                        action: 'syncTeachers',
                        data: JSON.stringify({
                            teachersSheetUrl: teachersSheetUrl,
                            teachersData: users
                        })
                    });

                    return fetch(`${webAppUrl}?${params}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (text.includes('success') || text.includes('berhasil')) {
                                    data = { success: true, message: 'Data guru berhasil disinkronkan!' };
                                } else {
                                    throw new Error('Response tidak valid');
                                }
                            }

                            if (data.success) {
                                showNotification(data.message || 'Data guru berhasil disinkronkan!', 'success');
                                return Promise.resolve(data);
                            } else {
                                showNotification(`Error: ${data.message}`, 'error');
                                return Promise.reject(data.message);
                            }
                        })
                        .catch(getError => {
                            console.error('Both POST and GET failed:', getError);
                            showNotification('Gagal menyinkronkan data guru!', 'error');
                            return Promise.reject(getError);
                        });
                });
        }





        // Notification system
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'96ef83b0d3343fdd',t:'MTc1NTE2NDY3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
